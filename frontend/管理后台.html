<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>加载中...</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- 引入Font Awesome图标 - 多CDN竞争加载 -->
<script>
(function() {
    var cdnList = [
        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css',
        'https://cdn.bootcdn.net/ajax/libs/font-awesome/6.5.1/css/all.min.css',
        'https://lib.baomitu.com/font-awesome/6.5.1/css/all.min.css'
    ];
    
    var loaded = false;
    var links = [];
    
    // 同时加载所有CDN
    cdnList.forEach(function(cdn) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = cdn;
        
        link.onload = function() {
            if (!loaded) {  // 第一个加载成功的
                loaded = true;
                console.log('✅ Font Awesome CDN加载成功:', cdn);
                // 移除其他未完成的链接
                links.forEach(function(l) {
                    if (l !== link && l.parentNode) {
                        l.parentNode.removeChild(l);
                    }
                });
            }
        };
        
        links.push(link);
        document.head.appendChild(link);
    });
})();
</script>
<style>
  :root {
    --primary: #6366f1;
    --secondary: #10b981;
  }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #f0f4ff 0%, #f7f9ff 100%);
    transition: background 0.3s ease, color 0.3s ease;
  }
  .text-gradient {
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-image: linear-gradient(to right, var(--primary), var(--secondary));
  }

  /* 夜间模式 */
  body.dark-mode {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #e4e6eb;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    transition: background 0.3s ease, border-color 0.3s ease;
  }

  .dark-mode .card {
    background: #242526;
    border: 1px solid #3e4042;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }

  .dark-mode input,
  .dark-mode textarea,
  .dark-mode select {
    background: #3e4042;
    border-color: #4e4f50;
    color: #e4e6eb;
  }

  .dark-mode .text-gray-500 {
    color: #b0b3b8;
  }

  .dark-mode .text-gray-400 {
    color: #8a8d91;
  }

  .dark-mode .text-gray-800 {
    color: #e4e6eb;
  }

  .dark-mode .text-gray-700 {
    color: #e4e6eb;
  }

  .dark-mode .text-gray-600 {
    color: #b0b3b8;
  }

  .dark-mode .border-gray-100 {
    border-color: #3e4042;
  }

  .dark-mode .border-gray-200 {
    border-color: #4e4f50;
  }

  .dark-mode .border-gray-50 {
    border-color: #3e4042;
  }

  .dark-mode .bg-gray-50 {
    background: #3e4042;
  }

  .dark-mode .bg-gray-100 {
    background: #3e4042;
  }

  .dark-mode .bg-white {
    background: #242526;
  }

  .dark-mode .hover\:bg-gray-50:hover {
    background: #3e4042;
  }

  .dark-mode .hover\:shadow-sm:hover {
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  .dark-mode .table-row:hover {
    background: #3e4042;
  }

  .dark-mode .toast {
    background: #3e4042;
    border-color: #4e4f50;
    color: #e4e6eb;
  }

  .dark-mode .toast.text-green-700 {
    color: #0be881;
  }

  .dark-mode .toast.bg-green-50 {
    background: #1a2e1a;
    border-color: #0be881;
  }

  .dark-mode .toast.text-red-700 {
    color: #ff6370;
  }

  .dark-mode .toast.bg-red-50 {
    background: #2e1a1a;
    border-color: #ff6370;
  }

  .dark-mode .bg-blue-50 {
    background: #1a243e;
  }

  .dark-mode .text-blue-600 {
    color: #5177ff;
  }

  .dark-mode .bg-green-50 {
    background: #1a2e1a;
  }

  .dark-mode .text-green-600 {
    color: #0be881;
  }

  .dark-mode .bg-red-50 {
    background: #2e1a1a;
  }

  .dark-mode .text-red-600 {
    color: #ff6370;
  }

  .dark-mode .bg-yellow-50 {
    background: #2e2a1a;
  }

  .dark-mode .text-yellow-600 {
    color: #ffd93d;
  }

  .dark-mode .bg-purple-50 {
    background: #2a1a2e;
  }

  .dark-mode .text-purple-600 {
    color: #a855f7;
  }

  .dark-mode .bg-pink-50 {
    background: #2e1a24;
  }

  .dark-mode .text-pink-600 {
    color: #ec4899;
  }

  .dark-mode .bg-cyan-50 {
    background: #1a242e;
  }

  .dark-mode .text-cyan-600 {
    color: #06b6d4;
  }

  .dark-mode .bg-indigo-50 {
    background: #1a1a2e;
  }

  .dark-mode .text-indigo-600 {
    color: #6366f1;
  }

  .dark-mode .bg-orange-50 {
    background: #2e241a;
  }

  .dark-mode .text-orange-600 {
    color: #f97316;
  }

  .dark-mode .fixed.bg-white {
    background: #1a1a2e;
    border-bottom: 1px solid #3e4042;
  }

  .dark-mode .text-blue-700 {
    color: #5177ff;
  }

  .dark-mode .border-b {
    border-bottom-color: #3e4042;
  }

  .dark-mode .font-mono {
    background: #3e4042;
  }

  .dark-mode .modal {
    background: rgba(0,0,0,0.7);
  }

  .dark-mode .modal > .bg-white {
    background: #242526;
  }

  .btn {
    border-radius: 10px;
    transition: all 0.2s;
    cursor: pointer;
  }
  .btn-primary {
    background: linear-gradient(90deg, #4169ff, #5177ff);
    color: white;
  }
  .btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(65, 105, 255, 0.2);
  }
  .btn-danger {
    background: linear-gradient(90deg, #ff4757, #ff6370);
    color: white;
  }
  .btn-danger:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 71, 87, 0.2);
  }
  .btn-success {
    background: linear-gradient(90deg, #05c46b, #0be881);
    color: white;
  }
  .btn-success:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(5, 196, 107, 0.2);
  }
  .btn-light {
    background: #f1f5ff;
    color: #374259;
  }
  .btn-light:hover {
    background: #e8f0fe;
    transform: translateY(-1px);
  }

  .dark-mode .btn-light {
    background: #3e4042;
    color: #e4e6eb;
  }

  .dark-mode .btn-light:hover {
    background: #4e4f50;
  }

  /* 暗色模式下主题切换按钮样式 */
  .dark-mode .theme-toggle {
    background: #3e4042;
  }

  .dark-mode .theme-toggle:hover {
    background: #4e4f50;
  }

  .modal {
    animation: fadeIn 0.2s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .table-row:hover {
    background: #f9fbfd;
  }
  .sidebar-item.active {
    background: #e8f0fe;
    color: #4169ff;
    font-weight: 600;
  }

  .dark-mode .sidebar-item.active {
    background: #3e4042;
    color: #5177ff;
  }

  .toast {
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .upload-area:hover {
    border-color: #4169ff;
    background: #f8fbff;
  }

  .dark-mode .upload-area:hover {
    border-color: #5177ff;
    background: #1a243e;
  }

  /* 主题切换按钮动画 */
  .theme-toggle {
    transition: transform 0.3s ease;
  }
  .theme-toggle:hover {
    transform: rotate(180deg);
  }
</style>
</head>
<body class="min-h-screen pb-20">

<!-- 获取系统基本信息，包括站点名称 -->
  <script>
    // 从系统配置中获取站点名称并更新页面标题和导航栏
    function updateSiteNameFromConfig(config) {
      if (config && config.site_name) {
        const siteName = config.site_name.value;
        document.title = siteName + ' - 管理后台';
        // 更新导航栏中的站点名称
        const navSiteNameElement = document.querySelector('span.text-gradient');
        if (navSiteNameElement) {
          navSiteNameElement.textContent = siteName;
        }
        console.log('✅ 从系统配置更新站点名称成功:', siteName);
      }
    }
  </script>

  <!-- 顶部导航 -->
<div class="fixed top-0 left-0 right-0 bg-white shadow-sm z-50">
  <div class="flex items-center justify-between px-4 h-16 max-w-7xl mx-auto">
    <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='/'" title="返回首页">
      <div class="w-10 h-10 rounded-full bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] flex items-center justify-center shadow-lg hover:shadow-xl transition-shadow">
        <i class="fa-solid fa-images text-white text-xl"></i>
      </div>
      <span class="text-xl font-bold text-gradient hover:opacity-80 transition-opacity">随机图片API</span>
    </div>
    <div class="flex items-center gap-4">
      <!-- 主题切换按钮 -->
      <button class="theme-toggle p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors" id="themeToggleBtn" title="切换主题">
        <i class="fa fa-sun text-gray-600" id="themeIcon"></i>
      </button>
      <!-- 通知铃铛 -->
      <button class="relative p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
        <i class="fa fa-bell text-gray-600"></i>
        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
      </button>
      <span class="text-sm text-gray-500">管理员</span>
      <button class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors" id="logoutBtn">
        <i class="fa fa-sign-out text-gray-600"></i>
      </button>
    </div>
  </div>
</div>

<!-- 主体 -->
<div class="pt-20 px-4 max-w-7xl mx-auto flex flex-col md:flex-row gap-6">

  <!-- 侧边栏 -->
  <div class="w-full md:w-56 shrink-0">
    <div class="card p-4 sticky top-20">
      <div class="text-xs text-gray-400 font-medium mb-2">管理菜单</div>
      <div class="flex flex-col gap-1">
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuImgManage">
          <i class="fa fa-th-large w-4 text-center"></i> 图片管理
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuCategory">
          <i class="fa fa-folder w-4 text-center"></i> 分类管理
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuUser">
          <i class="fa fa-users w-4 text-center"></i> 用户管理
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuFeedback">
          <i class="fa fa-comments w-4 text-center"></i> 用户反馈
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuSetting">
          <i class="fa fa-cog w-4 text-center"></i> 系统设置
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuLog">
          <i class="fa fa-history w-4 text-center"></i> 操作日志
        </button>
        <button class="sidebar-item btn btn-light flex items-center gap-2 px-3 py-2 text-left w-full text-sm font-medium" id="menuUpdate">
          <i class="fa fa-refresh w-4 text-center"></i> 系统更新
        </button>
      </div>
    </div>
  </div>

  <!-- 内容区 -->
  <div class="flex-1 space-y-6">

    <!-- 统计 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-4 hover:shadow-md transition-shadow">
        <div class="text-sm text-gray-500">总图片</div>
        <div class="text-2xl font-bold mt-1">2,589</div>
        <div class="text-xs text-green-500 mt-1"><i class="fa fa-arrow-up"></i> 较昨日 +12%</div>
      </div>
      <div class="card p-4 hover:shadow-md transition-shadow">
        <div class="text-sm text-gray-500">今日访问</div>
        <div class="text-2xl font-bold mt-1">15,682</div>
        <div class="text-xs text-green-500 mt-1"><i class="fa fa-arrow-up"></i> 较昨日 +8%</div>
      </div>
      <div class="card p-4 hover:shadow-md transition-shadow">
        <div class="text-sm text-gray-500">未读反馈</div>
        <div class="text-2xl font-bold mt-1 text-red-500">18</div>
        <div class="text-xs text-red-500 mt-1"><i class="fa fa-arrow-up"></i> 较昨日 +3</div>
      </div>
      <div class="card p-4 hover:shadow-md transition-shadow">
        <div class="text-sm text-gray-500">占用空间</div>
        <div class="text-2xl font-bold mt-1">12.8GB</div>
        <div class="text-xs text-yellow-500 mt-1"><i class="fa fa-exclamation-circle"></i> 已使用 64%</div>
      </div>
    </div>

    <!-- 图片管理 -->
    <div class="card p-5 hidden" id="imgManageSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">图片管理</h2>
        <div class="flex gap-2">
          <div class="relative">
            <input type="text" placeholder="搜索文件名/分类" class="pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <button id="btnUploadMain" class="btn btn-primary px-3 py-1.5 text-sm">
            <i class="fa fa-upload mr-1"></i> 上传
          </button>
        </div>
      </div>

      <!-- 批量操作工具栏 -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-light px-3 py-1 text-sm" id="selectAllBtn">
          <i class="fa fa-check-square-o mr-1"></i> 全选
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="selectNoneBtn">
          <i class="fa fa-square-o mr-1"></i> 取消全选
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="downloadSelectedBtn">
          <i class="fa fa-download mr-1"></i> 下载选中
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="moveSelectedBtn">
          <i class="fa fa-arrows mr-1"></i> 移动
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="renameSelectedBtn">
          <i class="fa fa-pencil mr-1"></i> 重命名
        </button>
        <button class="btn btn-danger px-3 py-1 text-sm" id="deleteSelectedBtn">
          <i class="fa fa-trash mr-1"></i> 删除选中
        </button>
        <select class="btn btn-light px-3 py-1 text-sm outline-none" id="imageCategoryFilter">
          <option value="">全部分类</option>
          <!-- 分类选项将从API动态加载 -->
        </select>
        <select class="btn btn-light px-3 py-1 text-sm outline-none">
          <option>按时间排序</option>
          <option>按大小排序</option>
          <option>按名称排序</option>
        </select>
      </div>

      <!-- 图片列表表格 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="imgTable">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-10">
                <input type="checkbox" class="rounded" id="headerCheckbox">
              </th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">预览</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">文件名</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">分类</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">大小</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">分辨率</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">上传时间</th>
            </tr>
          </thead>
          <tbody id="imageTableBody">
            <!-- 图片数据将从API动态加载 -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- 分类管理 -->
    <div class="card p-5 hidden" id="categorySection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">分类管理</h2>
        <button class="btn btn-primary px-3 py-1.5 text-sm" id="addCategoryBtn">
          <i class="fa fa-plus mr-1"></i> 新建分类
        </button>
      </div>

      <!-- 分类列表 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoryGrid">
        <!-- 分类数据将从API动态加载 -->
      </div>
    </div>

    <!-- 用户管理 -->
    <div class="card p-5 hidden" id="userSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">用户管理</h2>
        <div class="flex gap-2">
          <div class="relative">
            <input type="text" placeholder="搜索用户名/邮箱" class="pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <button class="btn btn-primary px-3 py-1.5 text-sm" id="addUserBtn">
            <i class="fa fa-plus mr-1"></i> 新建用户
          </button>
        </div>
      </div>

      <!-- 用户列表 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="userTable">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-10">
                <input type="checkbox" class="rounded" id="userHeaderCheckbox">
              </th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户ID</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户名</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">邮箱</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">角色</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">注册时间</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">最后登录</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">状态</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
    <tr>
      <td colspan="8" class="py-8 text-center text-gray-500">
        <i class="fa fa-user-o text-4xl mb-2"></i>
        <p>暂无用户数据</p>
      </td>
    </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-gray-500">
        显示 1-9 条，共 9 条
      </div>
    </div>

    <!-- 用户反馈 -->
    <div class="card p-5 hidden" id="feedbackSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">用户反馈</h2>
        <div class="flex gap-2">
          <div class="relative">
            <input type="text" placeholder="搜索反馈内容" class="pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <button class="btn btn-primary px-3 py-1.5 text-sm" id="addFeedbackBtn">
            <i class="fa fa-plus mr-1"></i> 新建反馈
          </button>
        </div>
      </div>

      <!-- 反馈列表 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="feedbackTable">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-10">
                <input type="checkbox" class="rounded" id="feedbackHeaderCheckbox">
              </th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">反馈ID</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户ID</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">反馈内容</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">反馈时间</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">状态</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-32">操作</th>
            </tr>
          </thead>
          <tbody id="feedbackTableBody">
            <tr>
              <td colspan="7" class="py-8 text-center text-gray-500">
                <i class="fa fa-comment-o text-4xl mb-2"></i>
                <p>暂无反馈数据</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-gray-500">
        显示 1-10 条，共 10 条
      </div>
    </div>

    <!-- 系统设置 -->
    <div class="card p-5 hidden" id="settingSection">
      <h2 class="text-lg font-semibold mb-6">系统设置</h2>

      <div class="space-y-6">
        <!-- 基本设置 -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-2 border-b border-gray-100">基本设置</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-700 mb-1 block">站点名称</label>
              <input type="text" id="siteName" value="随机图API" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
            </div>
            <div>
              <label class="text-sm text-gray-700 mb-1 block">站点域名</label>
              <input type="text" id="siteDomain" value="https://api.example.com" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
            </div>
            <div>
              <label class="text-sm text-gray-700 mb-1 block">ICP备案号</label>
              <input type="text" id="icpBeian" value="京ICP备1234XXX号" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
            </div>
            <div>
              <label class="text-sm text-gray-700 mb-1 block">备案信息链接</label>
              <input type="text" id="beianLink" value="https://beian.miit.gov.cn" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
            </div>
            <div>
              <label class="text-sm text-gray-700 mb-1 block">时区设置</label>
              <select id="timezone" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
                <option value="America/New_York">America/New_York (UTC-5)</option>
                <option value="Europe/London">Europe/London (UTC+0)</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-700 mb-1 block">站点图标地址</label>
              <input type="text" id="faviconUrl" placeholder="例如：static/favicon.ico 或 https://example.com/favicon.ico" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
            </div>
          </div>
        </div>

        <!-- 安全设置 -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-3 pb-2 border-b border-gray-100">安全设置</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">启用访问日志</div>
                <div class="text-xs text-gray-400">记录所有API请求日志</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enableAccessLog" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">显示备案信息</div>
                <div class="text-xs text-gray-400">页脚显示备案信息</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="showBeianInfo" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">启用路径穿越防护</div>
                <div class="text-xs text-gray-400">防止恶意请求访问服务器其他目录</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enablePathTraversalProtection" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">启用防盗链</div>
                <div class="text-xs text-gray-400">仅允许指定域名引用图片</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enableHotlinkProtection" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">启用IP黑名单</div>
                <div class="text-xs text-gray-400">封禁恶意IP访问</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enableIpBlacklist" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button class="btn btn-light px-4 py-2" id="resetDefaultBtn">重置默认</button>
          <button class="btn btn-primary px-4 py-2" id="saveSettingsBtn">
            <i class="fa fa-save mr-1"></i> 保存设置
          </button>
        </div>
      </div>
    </div>

    <!-- 操作日志 -->
    <div class="card p-5 hidden" id="logSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">操作日志</h2>
        <div class="flex gap-2">
          <div class="relative">
            <input type="text" placeholder="搜索操作内容" class="pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <button class="btn btn-primary px-3 py-1.5 text-sm" id="clearLogBtn">
            <i class="fa fa-trash mr-1"></i> 清空日志
          </button>
        </div>
      </div>

      <!-- 日志列表 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="logTable">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-10">
                <input type="checkbox" class="rounded" id="logHeaderCheckbox">
              </th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">日志ID</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作用户</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作内容</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作时间</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作IP</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-32">操作</th>
            </tr>
          </thead>
          <tbody id="logTableBody">
            <tr>
              <td colspan="7" class="py-8 text-center text-gray-500">
                <i class="fa fa-history text-4xl mb-2"></i>
                <p>暂无日志数据</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-gray-500">
        显示 1-10 条，共 10 条
      </div>
    </div>

    <!-- 系统更新 -->
    <div class="card p-5 hidden" id="updateSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">系统更新</h2>
      </div>

      <!-- 版本信息 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="card p-4 bg-blue-50 hover:shadow-md transition-shadow">
          <div class="text-sm text-gray-500">当前版本</div>
          <div class="text-2xl font-bold mt-1 text-blue-600" id="currentVersion">加载失败</div>
          <div class="text-xs text-gray-500 mt-1" id="currentVersionDate">加载失败</div>
        </div>
        <div class="card p-4 bg-green-50 hover:shadow-md transition-shadow">
          <div class="text-sm text-gray-500">最新版本</div>
          <div class="text-2xl font-bold mt-1 text-green-600" id="latestVersion">加载失败</div>
          <div class="text-xs text-gray-500 mt-1" id="latestVersionDate">加载失败</div>
        </div>
      </div>

      <!-- 更新按钮 -->
      <div class="mb-6">
        <button id="btnCheckUpdate" class="btn btn-primary px-4 py-2 mr-2">
          <i class="fa fa-check-circle mr-1"></i> 检查更新
        </button>
        <button id="btnUpdateSystem" class="btn btn-success px-4 py-2 opacity-50 cursor-not-allowed" disabled>
          <i class="fa fa-download mr-1"></i> 更新系统
        </button>
        <div class="text-xs text-gray-500 mt-2">
          <i class="fa fa-info-circle mr-1"></i> 更新过程中请不要重启系统，系统会自动重载
        </div>
      </div>

      <!-- 版本更新日志 -->
      <div class="mb-6">
        <h3 class="text-md font-semibold mb-3">版本更新日志</h3>
        <div class="card p-4 bg-gray-50" id="changelogContent">
          <!-- 更新日志将从GitHub获取 -->
        </div>
      </div>

      <!-- 备份回滚 -->
      <div>
        <h3 class="text-md font-semibold mb-3">备份回滚</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="backupTable">
            <thead>
              <tr class="border-b border-gray-100">
                <th class="py-3 px-2 text-left font-medium text-gray-500">备份时间</th>
                <th class="py-3 px-2 text-left font-medium text-gray-500">版本号</th>
                <th class="py-3 px-2 text-left font-medium text-gray-500">备份大小</th>
                <th class="py-3 px-2 text-left font-medium text-gray-500">操作</th>
              </tr>
            </thead>
            <tbody id="backupTableBody">
              <!-- 备份数据将从后端API加载 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 获取系统时区配置
    getSystemTimezone();
    
    // 获取系统基本信息，包括站点名称
    getSystemInfo();
    
    // 初始化默认激活第一个菜单
    document.getElementById('menuImgManage').classList.add('active');
    // 默认显示图片管理页面
    document.getElementById('imgManageSection').style.display = 'block';
    
    // 为检查更新按钮添加点击事件
    const btnCheckUpdate = document.getElementById('btnCheckUpdate');
    if (btnCheckUpdate) {
      btnCheckUpdate.addEventListener('click', async function() {
        await checkForUpdates();
      });
    }
    
    // 为更新系统按钮添加点击事件
    const btnUpdateSystem = document.getElementById('btnUpdateSystem');
    if (btnUpdateSystem) {
      btnUpdateSystem.addEventListener('click', async function() {
        await executeUpdate();
      });
    }
    
    // 初始加载版本信息 - 注释掉，避免页面加载时自动检查更新
    // checkForUpdates();
    
    // 初始加载备份列表 - 注释掉，避免页面加载时自动加载备份列表
    // loadBackupList();
  });
  
  // 检查更新
  async function checkForUpdates() {
    try {
      // 显示加载状态
      const currentVersion = document.getElementById('currentVersion');
      const currentVersionDate = document.getElementById('currentVersionDate');
      const latestVersion = document.getElementById('latestVersion');
      const latestVersionDate = document.getElementById('latestVersionDate');
      const changelogContent = document.getElementById('changelogContent');
      
      if (currentVersion) currentVersion.textContent = '加载中...';
      if (currentVersionDate) currentVersionDate.textContent = '加载中...';
      if (latestVersion) latestVersion.textContent = '加载中...';
      if (latestVersionDate) latestVersionDate.textContent = '加载中...';
      if (changelogContent) {
        changelogContent.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>加载中...</p>
            <p class="mt-2 text-sm">正在获取更新日志</p>
          </div>
        `;
      }
      
      // 1. 获取本地版本信息
      let localVersionData = null;
      try {
        const versionResponse = await fetch('/api/system/version', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (versionResponse.ok) {
          localVersionData = await versionResponse.json();
          if (localVersionData.code === 200) {
            // 更新当前版本信息
            const currentVersionEl = document.getElementById('currentVersion');
            const currentVersionDateEl = document.getElementById('currentVersionDate');
            if (currentVersionEl) currentVersionEl.textContent = localVersionData.data.version || '未知';
            if (currentVersionDateEl) currentVersionDateEl.textContent = '发布于: 未知';
          }
        } else {
          console.error('获取本地版本信息失败:', versionResponse.status);
          if (currentVersion) currentVersion.textContent = '加载失败';
          if (currentVersionDate) currentVersionDate.textContent = '加载失败';
        }
      } catch (error) {
        console.error('获取本地版本信息失败:', error);
        if (currentVersion) currentVersion.textContent = '加载失败';
        if (currentVersionDate) currentVersionDate.textContent = '加载失败';
      }
      
      // 2. 获取最新版本信息和更新日志
      let githubVersionData = null;
      try {
        const response = await fetch('/api/system/check-update', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          githubVersionData = await response.json();
          if (githubVersionData.code === 200) {
            // 更新最新版本信息
            const latestVersionEl = document.getElementById('latestVersion');
            const latestVersionDateEl = document.getElementById('latestVersionDate');
            if (latestVersionEl) latestVersionEl.textContent = githubVersionData.data.latest_version || '未知';
            if (latestVersionDateEl) latestVersionDateEl.textContent = `发布于: ${githubVersionData.data.latest_version_date || '未知'}`;
            
            // 更新更新日志
            const changelogContentEl = document.getElementById('changelogContent');
            if (changelogContentEl) {
              if (githubVersionData.data.changelog && githubVersionData.data.changelog.length > 0) {
                // 构建更新日志HTML
                let changelogHTML = '';
                githubVersionData.data.changelog.forEach((item, index) => {
                  changelogHTML += `
                    <div class="mb-6 pb-4 border-b border-gray-200 last:border-0">
                      <div class="font-semibold text-lg text-blue-600">${item.version} (${item.date})</div>
                      <ul class="mt-2 space-y-1">
                        ${item.changes.map(change => `
                          <li class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>${change}</span>
                          </li>
                        `).join('')}
                      </ul>
                    </div>
                  `;
                });
                changelogContentEl.innerHTML = changelogHTML;
              } else {
                changelogContentEl.textContent = '暂无更新日志';
              }
            }
          }
        } else {
          console.error('获取最新版本信息失败:', response.status);
          if (latestVersion) latestVersion.textContent = '加载失败';
          if (latestVersionDate) latestVersionDate.textContent = '加载失败';
          if (changelogContent) {
            changelogContent.innerHTML = `
              <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 text-center">
                <div class="text-yellow-600 dark:text-yellow-400 font-medium mb-2">
                  <i class="fas fa-exclamation-triangle mr-2"></i>加载更新日志失败
                </div>
                <div class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                  暂时无法获取GitHub Releases数据
                </div>
                <a href="https://github.com/YunJian101/Random-Pictures/releases" target="_blank"
                   class="inline-flex items-center px-4 py-2 bg-primary text-black dark:text-white rounded-lg hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg">
                  <i class="fab fa-github mr-2"></i>前往 GitHub Releases 查看
                </a>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('获取最新版本信息失败:', error);
        if (latestVersion) latestVersion.textContent = '加载失败';
        if (latestVersionDate) latestVersionDate.textContent = '加载失败';
        if (changelogContent) {
          changelogContent.innerHTML = `
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 text-center">
              <div class="text-yellow-600 dark:text-yellow-400 font-medium mb-2">
                <i class="fas fa-exclamation-triangle mr-2"></i>加载更新日志失败
              </div>
              <div class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                暂时无法获取GitHub Releases数据
              </div>
              <a href="https://github.com/YunJian101/Random-Pictures/releases" target="_blank"
                 class="inline-flex items-center px-4 py-2 bg-primary text-black dark:text-white rounded-lg hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg">
                <i class="fab fa-github mr-2"></i>前往 GitHub Releases 查看
              </a>
            </div>
          `;
        }
      }
      
      // 3. 检查版本更新并控制更新按钮状态
      if (localVersionData && localVersionData.code === 200 && githubVersionData && githubVersionData.code === 200) {
        checkVersionUpdate({
          current_version: localVersionData.data.version,
          latest_version: githubVersionData.data.latest_version
        });
      }
    } catch (error) {
      console.error('检查更新失败:', error);
      
      showToast('检查更新失败');
    }
  }
  
  // 检查版本更新并控制更新按钮状态
  function checkVersionUpdate(updateInfo) {
    const currentVersion = updateInfo.current_version || document.getElementById('currentVersion').textContent;
    const latestVersion = updateInfo.latest_version || document.getElementById('latestVersion').textContent;
    const updateButton = document.getElementById('btnUpdateSystem');
    
    // 移除版本号中的非数字字符，只保留数字和点
    function cleanVersion(version) {
      return version.replace(/[^0-9.]/g, '');
    }
    
    // 比较版本号
    function compareVersions(v1, v2) {
      const v1Parts = cleanVersion(v1).split('.').map(Number);
      const v2Parts = cleanVersion(v2).split('.').map(Number);
      
      for (let i = 0; i < Math.max(v1Parts.length, v2Parts.length); i++) {
        const v1Part = v1Parts[i] || 0;
        const v2Part = v2Parts[i] || 0;
        
        if (v1Part < v2Part) return -1;
        if (v1Part > v2Part) return 1;
      }
      
      return 0;
    }
    
    // 判断是否有更新可用
    const hasUpdate = currentVersion !== '加载失败' && 
                     latestVersion !== '加载失败' && 
                     compareVersions(currentVersion, latestVersion) < 0;
    
    if (hasUpdate) {
      updateButton.disabled = false;
      updateButton.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      updateButton.disabled = true;
      updateButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }
  
  // 执行更新
  async function executeUpdate() {
    try {
      // 显示加载状态
      const updateButton = document.getElementById('btnUpdateSystem');
      const originalText = updateButton.innerHTML;
      updateButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 更新中...';
      updateButton.disabled = true;
      
      // 调用新的执行更新API
      const response = await fetch('/api/system/execute-update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        showToast('系统更新成功，正在重启...');
        // 可以添加重启后自动刷新页面的逻辑
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      } else {
        showToast('系统更新失败: ' + data.msg);
        updateButton.innerHTML = originalText;
        updateButton.disabled = false;
      }
    } catch (error) {
      console.error('执行更新失败:', error);
      showToast('执行更新失败，请检查网络连接');
      const updateButton = document.getElementById('btnUpdateSystem');
      updateButton.innerHTML = '<i class="fa fa-download mr-1"></i> 更新系统';
      updateButton.disabled = false;
    }
  }
  
  // 加载备份列表
  async function loadBackupList() {
    try {
      const response = await fetch('/api/system/backups', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      if (data.code === 200) {
        renderBackupList(data.data.backups);
      } else {
        throw new Error(data.msg || '获取备份列表失败');
      }
    } catch (error) {
      console.error('加载备份列表失败:', error);
      // 直接在表格中显示错误信息
      const tbody = document.getElementById('backupTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="py-8 text-center text-red-500">加载备份列表失败: ${error.message}</td>
          </tr>
        `;
      }
      showToast('加载备份列表失败: ' + error.message);
    }
  }
  
  // 渲染备份列表
  function renderBackupList(backups) {
    const tbody = document.getElementById('backupTableBody');
    if (!tbody) return;
    
    if (!backups || backups.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="py-8 text-center text-gray-500">暂无备份数据</td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = backups.map(backup => `
      <tr class="border-b border-gray-100 hover:bg-gray-50">
        <td class="py-3 px-2">${backup.time}</td>
        <td class="py-3 px-2">${backup.version}</td>
        <td class="py-3 px-2">${backup.size}</td>
        <td class="py-3 px-2">
          <button class="btn btn-primary px-2 py-1 text-xs" onclick="rollbackToBackup('${backup.filename}')">
            <i class="fa fa-undo mr-1"></i> 回滚
          </button>
        </td>
      </tr>
    `).join('');
  }
  
  // 回滚到备份
  async function rollbackToBackup(backupFilename) {
    try {
      if (!confirm('确定要回滚到这个备份吗？此操作将覆盖当前版本！')) {
        return;
      }
      
      // 调用回滚API
      const response = await fetch('/api/system/rollback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ backup_path: backupFilename })
      });
      
      const data = await response.json();
      if (data.code === 200) {
        showToast('系统回滚成功，正在重启...');
        // 可以添加重启后自动刷新页面的逻辑
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      } else {
        showToast('系统回滚失败: ' + data.msg);
      }
    } catch (error) {
      console.error('执行回滚失败:', error);
      showToast('执行回滚失败，请检查网络连接');
    }
  }

  // 显示提示信息
  function showToast(message) {
    // 创建toast元素
    const toast = document.createElement('div');
    toast.className = 'fixed top-20 right-4 bg-white p-4 rounded-lg shadow-lg z-50 toast';
    toast.textContent = message;
    
    // 添加到页面
    document.body.appendChild(toast);
    
    // 3秒后移除
    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

// ==================== 用户管理功能 ====================
// 从后端API加载用户数据
async function loadUsersFromAPI() {
  try {
    console.log('开始从后端API加载用户数据...');
    const response = await fetch('/api/users', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    console.log('API响应状态:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('API返回数据:', result);
    
    if (result.code === 200) {
      renderUsersFromAPI(result.data.users);
    } else {
      console.error('获取用户列表失败:', result.msg);
      showErrorInUserSection('获取用户列表失败: ' + result.msg);
    }
  } catch (error) {
    console.error('网络错误:', error);
    showErrorInUserSection('网络连接失败，请检查后端服务是否启动');
  }
}

// 渲染从API获取的用户列表
function renderUsersFromAPI(users) {
  const tbody = document.getElementById('userTableBody');
  
  if (!users || users.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="py-8 text-center text-gray-500">
          <i class="fa fa-user-o text-4xl mb-2"></i>
          <p>暂无用户数据</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = users.map(user => `
    <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer user-row" data-user-id="${user.id}">
      <td class="py-3 px-2" onclick="event.stopPropagation()">
        <input type="checkbox" class="rounded user-checkbox" data-user-id="${user.id}">
      </td>
      <td class="py-3 px-2 font-mono text-sm text-gray-600">#${user.id}</td>
      <td class="py-3 px-2">
        <div class="flex items-center gap-3">
          <img src="${user.avatar_url}" alt="${user.username}" class="w-8 h-8 rounded-full">
          <span>${user.username}</span>
        </div>
      </td>
      <td class="py-3 px-2">${user.email || '-'}</td>
      <td class="py-3 px-2">
        <span class="px-2 py-0.5 ${user.role === 'admin' ? 'bg-purple-50 text-purple-600' : 'bg-blue-50 text-blue-600'} text-xs rounded-full">
          ${user.role === 'admin' ? '管理员' : '普通用户'}
        </span>
      </td>
      <td class="py-3 px-2 text-gray-500">${formatDateWithTimezone(user.created_at)}</td>
      <td class="py-3 px-2 text-gray-500">${user.last_login && user.last_login.trim() ? formatTimeWithTimezone(user.last_login) : '-'}</td>
      <td class="py-3 px-2">
        <span class="px-2 py-0.5 ${user.is_banned ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'} text-xs rounded-full">
          ${user.is_banned ? '已封禁' : '正常'}
        </span>
      </td>
    </tr>
  `).join('');
  
  // 更新用户总数显示
  const countDisplay = document.querySelector('#userSection .mt-4.text-gray-500');
  if (countDisplay) {
    countDisplay.textContent = `共 ${users.length} 条`;
  }
}

// 显示错误信息在用户管理区域
function showErrorInUserSection(message) {
  const tbody = document.getElementById('userTableBody');
  tbody.innerHTML = `
    <tr>
      <td colspan="8" class="py-8 text-center text-red-500">
        <i class="fa fa-exclamation-circle text-4xl mb-2"></i>
        <p>${message}</p>
        <button class="btn btn-primary mt-4" onclick="loadUsersFromAPI()">重新加载</button>
      </td>
    </tr>
  `;
}

// 用户操作事件监听器
document.addEventListener('click', function(e) {
  // 点击用户行查看详情
  if (e.target.closest('.user-row')) {
    const userId = e.target.closest('.user-row').dataset.userId;
    if (userId) {
      viewUserDetail(userId);
    }
  }
  
  // 编辑用户
  if (e.target.closest('.editUserBtn')) {
    const userId = e.target.closest('.editUserBtn').dataset.userId;
    editUser(userId);
  }
  
  // 封禁用户
  if (e.target.closest('.banUserBtn')) {
    const userId = e.target.closest('.banUserBtn').dataset.userId;
    banUser(userId);
  }
  
  // 解封用户
  if (e.target.closest('.unbanUserBtn')) {
    const userId = e.target.closest('.unbanUserBtn').dataset.userId;
    unbanUser(userId);
  }
  
  // 删除用户
  if (e.target.closest('.deleteUserBtn')) {
    const userId = e.target.closest('.deleteUserBtn').dataset.userId;
    deleteUser(userId);
  }
});

// 用户操作函数
async function viewUserDetail(userId) {
  try {
    const response = await fetch(`/api/users/${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

      const result = await response.json();
      if (result.code === 200) {
        const user = result.data.user;
        // 填充详情弹窗
        document.getElementById('detailUserAvatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=4169ff&color=fff&size=128`;
        document.getElementById('detailUserName').textContent = user.username;
        document.getElementById('detailUserEmail').textContent = user.email || '-';
        document.getElementById('detailUserId').textContent = `#${user.id}`;
        document.getElementById('detailUserType').textContent = user.role === 'admin' ? '管理员' : (user.role === 'vip' ? 'VIP用户' : '普通用户');
        document.getElementById('detailRegisterTime').textContent = user.created_at ? formatDateWithTimezone(user.created_at) : '-';
        document.getElementById('detailLastLoginIP').textContent = user.last_login ? formatTimeWithTimezone(user.last_login) : '-';

      // 设置状态徽章
      const statusBadge = document.getElementById('detailUserStatusBadge');
      if (user.is_banned) {
        statusBadge.textContent = '已封禁';
        statusBadge.className = 'inline-block px-2 py-1 rounded text-xs bg-red-50 text-red-600';
      } else {
        statusBadge.textContent = '活跃';
        statusBadge.className = 'inline-block px-2 py-1 rounded text-xs bg-green-50 text-green-600';
      }

      // 存储用户ID用于编辑/删除
      document.getElementById('detailUserId').dataset.userId = user.id;

      // 设置封禁/解除按钮
      const banUnbanBtn = document.getElementById('banUnbanFromDetailBtn');
      if (user.is_banned) {
        banUnbanBtn.innerHTML = '<i class="fa fa-check-circle mr-1"></i> 解除封禁';
        banUnbanBtn.className = 'btn btn-success flex-1 px-3 py-2 text-sm unbanUserFromDetailBtn';
      } else {
        banUnbanBtn.innerHTML = '<i class="fa fa-ban mr-1"></i> 封禁用户';
        banUnbanBtn.className = 'btn btn-warning flex-1 px-3 py-2 text-sm banUserFromDetailBtn';
      }

      // 显示弹窗
      document.getElementById('modalUserDetail').style.display = 'flex';
    } else {
      showToast('获取用户详情失败: ' + result.msg);
    }
  } catch (error) {
    showToast('网络错误: ' + error.message);
  }
}

async function editUser(userId) {
  try {
    // 先获取用户详情
    const response = await fetch(`/api/users/${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const result = await response.json();
    if (result.code === 200) {
      const user = result.data.user;

      // 填充编辑表单
      document.getElementById('userModalTitle').textContent = '编辑用户';
      document.getElementById('userName').value = user.username;
      document.getElementById('userEmail').value = user.email || '';
      document.getElementById('userPassword').value = '';
      document.getElementById('userType').value = user.role === 'admin' ? 'admin' : (user.role === 'vip' ? 'vip' : 'normal');
      document.getElementById('userStatus').value = user.is_banned ? 'banned' : 'active';
      document.getElementById('saveUserBtn').dataset.userId = userId;

      // 显示编辑弹窗
      document.getElementById('modalUser').style.display = 'flex';
    } else {
      showToast('获取用户信息失败: ' + result.msg);
    }
  } catch (error) {
    showToast('网络错误: ' + error.message);
  }
}

async function banUser(userId) {
  document.getElementById('banUserId').value = userId;
  document.getElementById('banReason').value = '';
  document.getElementById('modalBanUser').style.display = 'flex';
}

async function unbanUser(userId) {
  document.getElementById('unbanUserId').value = userId;
  document.getElementById('modalUnbanUser').style.display = 'flex';
}

async function deleteUser(userId) {
  document.getElementById('deleteUserId').value = userId;
  document.getElementById('modalDeleteUser').style.display = 'flex';
}

// 详情弹窗中的封禁/解除、编辑和删除按钮
document.addEventListener('click', async function(e) {
  // 详情弹窗中的封禁用户按钮
  if (e.target.closest('.banUserFromDetailBtn')) {
    const userId = document.getElementById('detailUserId')?.dataset.userId;
    if (userId) {
      document.getElementById('modalUserDetail').style.display = 'none';
      banUser(userId);
    }
  }

  // 详情弹窗中的解除封禁按钮
  if (e.target.closest('.unbanUserFromDetailBtn')) {
    const userId = document.getElementById('detailUserId')?.dataset.userId;
    if (userId) {
      document.getElementById('modalUserDetail').style.display = 'none';
      unbanUser(userId);
    }
  }

  // 详情弹窗中的编辑按钮
  if (e.target.closest('#editFromDetailBtn')) {
    const userId = document.getElementById('detailUserId')?.dataset.userId;
    if (userId) {
      document.getElementById('modalUserDetail').style.display = 'none';
      editUser(userId);
    }
  }

  // 详情弹窗中的删除按钮
  if (e.target.closest('#deleteFromDetailBtn')) {
    const userId = document.getElementById('detailUserId')?.dataset.userId;
    if (userId) {
      document.getElementById('modalUserDetail').style.display = 'none';
      deleteUser(userId);
    }
  }
});

// 修复上传区域相关的addEventListener错误
document.addEventListener('DOMContentLoaded', function() {
  // 安全地添加上传区域事件监听器
  const mainUploadArea = document.getElementById('mainUploadArea');
  if (mainUploadArea) {
    mainUploadArea.addEventListener('click', () => {
      const mainFileInput = document.getElementById('mainFileInput');
      if (mainFileInput) {
        mainFileInput.click();
      }
    });
  }

  // 获取系统配置
  getSystemConfig();

  // 保存设置按钮
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener('click', saveSystemConfig);
  }

  // 重置默认按钮
  const resetDefaultBtn = document.getElementById('resetDefaultBtn');
  if (resetDefaultBtn) {
    resetDefaultBtn.addEventListener('click', resetToDefaultSettings);
  }

  const mainFileInput = document.getElementById('mainFileInput');
  if (mainFileInput) {
    mainFileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const mainUploadList = document.getElementById('mainUploadList');
        if (mainUploadList) {
          mainUploadList.style.display = 'block';
          showToast(`已选择 ${this.files.length} 个文件`);
        }
      }
    });
  }

  // 封禁确认按钮
  const confirmBanUserBtn = document.getElementById('confirmBanUserBtn');
  if (confirmBanUserBtn) {
    confirmBanUserBtn.addEventListener('click', async function() {
      const userId = document.getElementById('banUserId').value;
      const reason = document.getElementById('banReason').value;

      try {
        const response = await fetch(`/api/users/${userId}/ban`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason: reason })
        });

        const result = await response.json();
        if (result.code === 200) {
          showToast('用户封禁成功');
          document.getElementById('modalBanUser').style.display = 'none';
          loadUsersFromAPI();
        } else {
          showToast('封禁失败: ' + result.msg);
        }
      } catch (error) {
        showToast('网络错误: ' + error.message);
      }
    });
  }

  // 解封确认按钮
  const confirmUnbanUserBtn = document.getElementById('confirmUnbanUserBtn');
  if (confirmUnbanUserBtn) {
    confirmUnbanUserBtn.addEventListener('click', async function() {
      const userId = document.getElementById('unbanUserId').value;

      try {
        const response = await fetch(`/api/users/${userId}/unban`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (result.code === 200) {
          showToast('用户解封成功');
          document.getElementById('modalUnbanUser').style.display = 'none';
          loadUsersFromAPI();
        } else {
          showToast('解封失败: ' + result.msg);
        }
      } catch (error) {
        showToast('网络错误: ' + error.message);
      }
    });
  }

  // 删除确认按钮
  const confirmDeleteUserBtn = document.getElementById('confirmDeleteUserBtn');
  if (confirmDeleteUserBtn) {
    confirmDeleteUserBtn.addEventListener('click', async function() {
      const userId = document.getElementById('deleteUserId').value;

      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (result.code === 200) {
          showToast('用户删除成功');
          document.getElementById('modalDeleteUser').style.display = 'none';
          loadUsersFromAPI();
        } else {
          showToast('删除失败: ' + result.msg);
        }
      } catch (error) {
        showToast('网络错误: ' + error.message);
      }
    });
  }
});

</script>

</body>
</html>            
          </div>
        </div>
      </div>
    </div>

    <!-- 用户管理 -->
    <div class="card p-5 hidden" id="userSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">用户管理</h2>
        <div class="flex gap-2">
          <div class="relative">
            <input type="text" placeholder="搜索用户名/邮箱/IP" class="pl-8 pr-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" id="userSearchInput">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <button class="btn btn-primary px-3 py-1.5 text-sm" id="addUserBtn">
            <i class="fa fa-user-plus mr-1"></i> 添加用户
          </button>
        </div>
      </div>

      <!-- 用户筛选工具栏 -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <select class="btn btn-light px-3 py-1 text-sm outline-none" id="userStatusFilter">
          <option value="">全部状态</option>
          <option value="active">活跃</option>
          <option value="banned">已封禁</option>
          <option value="pending">待审核</option>
        </select>
        <select class="btn btn-light px-3 py-1 text-sm outline-none" id="userTypeFilter">
          <option value="">全部类型</option>
          <option value="normal">普通用户</option>
          <option value="vip">VIP用户</option>
          <option value="admin">管理员</option>
        </select>
        <button class="btn btn-light px-3 py-1 text-sm" id="refreshUsersBtn">
          <i class="fa fa-refresh mr-1"></i> 刷新
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="exportUsersBtn">
          <i class="fa fa-download mr-1"></i> 导出
        </button>
      </div>

      <!-- 用户列表表格 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="userTable">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-10">
                <input type="checkbox" class="rounded" id="userHeaderCheckbox">
              </th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户ID</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户名</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">邮箱</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">用户类型</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">注册时间</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">最后登录</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">状态</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500 w-32">操作</th>
            </tr>
          </thead>
          <tbody id="userTableBody">

          </tbody>
        </table>
      </div>

      <!-- 批量操作工具栏 -->
      <div class="flex gap-2 mt-4 mb-4 flex-wrap">
        <button class="btn btn-light px-3 py-1 text-sm" id="selectAllUsersBtn">
          <i class="fa fa-check-square-o mr-1"></i> 全选
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="selectNoneUsersBtn">
          <i class="fa fa-square-o mr-1"></i> 取消全选
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="batchBanBtn">
          <i class="fa fa-ban mr-1"></i> 批量封禁
        </button>
        <button class="btn btn-light px-3 py-1 text-sm" id="batchUnbanBtn">
          <i class="fa fa-check-circle mr-1"></i> 批量解封
        </button>
        <button class="btn btn-danger px-3 py-1 text-sm" id="batchDeleteUsersBtn">
          <i class="fa fa-trash mr-1"></i> 批量删除
        </button>
      </div>

    </div>

    <!-- 操作日志 -->
    <div class="card p-5 hidden" id="logSection">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h2 class="text-lg font-semibold">操作日志</h2>
        <div class="flex gap-2">
          <select class="btn btn-light px-3 py-1 text-sm outline-none">
            <option>全部操作类型</option>
            <option>上传</option>
            <option>删除</option>
            <option>修改</option>
            <option>系统设置</option>
          </select>
          <button class="btn btn-light px-3 py-1 text-sm">
            <i class="fa fa-download mr-1"></i> 导出日志
          </button>
          <button class="btn btn-light px-3 py-1 text-sm">
            <i class="fa fa-trash mr-1"></i> 清空日志
          </button>
        </div>
      </div>

      <!-- 日志表格 -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="py-3 px-2 text-left font-medium text-gray-500">时间</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作人</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作类型</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">操作内容</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">IP地址</th>
              <th class="py-3 px-2 text-left font-medium text-gray-500">状态</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 15:32:18</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">上传</span></td>
              <td class="py-3 px-2">上传图片 anime_004.webp 到二次元分类</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 15:28:45</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-red-50 text-red-600 text-xs rounded-full">删除</span></td>
              <td class="py-3 px-2">删除图片 old_img_001.jpg</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 14:56:22</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded-full">修改</span></td>
              <td class="py-3 px-2">重命名图片 nature_129.png 为 nature_129_new.png</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 14:23:08</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full">系统设置</span></td>
              <td class="py-3 px-2">修改系统设置 - 请求频率限制: 每IP每分钟 60 次</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 13:45:33</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">上传</span></td>
              <td class="py-3 px-2">批量上传 5 张图片到人物分类</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 11:20:15</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded-full">修改</span></td>
              <td class="py-3 px-2">移动图片 people_023.jpg 到自然风光分类</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-10 10:05:47</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full">系统设置</span></td>
              <td class="py-3 px-2">修改系统设置 - 启用防盗链: 是</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-09 23:18:56</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">上传</span></td>
              <td class="py-3 px-2">上传图片 wallpaper_022.png 到壁纸分类</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-09 18:42:30</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-purple-50 text-purple-600 text-xs rounded-full">分类管理</span></td>
              <td class="py-3 px-2">新建分类 "壁纸"</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-green-500">成功</span></td>
            </tr>
            <tr class="table-row border-b border-gray-50">
              <td class="py-3 px-2 text-gray-500">2026-02-09 16:30:12</td>
              <td class="py-3 px-2">admin</td>
              <td class="py-3 px-2"><span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">上传</span></td>
              <td class="py-3 px-2">批量上传 12 张图片到二次元分类</td>
              <td class="py-3 px-2 text-gray-500">192.168.1.1</td>
              <td class="py-3 px-2"><span class="text-red-500">失败</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 日志分页 -->
      <div class="flex justify-between items-center mt-4 text-sm">
        <div class="text-gray-500">显示 1-8 条，共 2,456 条</div>
        <div class="flex gap-1">
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">«</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0 bg-blue-50 text-blue-600">1</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">2</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">3</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">4</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">5</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">»</button>
        </div>
      </div>
    </div>

    <!-- 用户反馈 -->
    <div class="card p-5 hidden" id="feedbackSection">
      <h2 class="text-lg font-semibold mb-4">用户反馈 & 申诉</h2>

      <!-- 反馈筛选 -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <select class="btn btn-light px-3 py-1 text-sm outline-none">
          <option>全部状态</option>
          <option>未处理</option>
          <option>处理中</option>
          <option>已解决</option>
          <option>已驳回</option>
        </select>
        <select class="btn btn-light px-3 py-1 text-sm outline-none">
          <option>全部类型</option>
          <option>申诉</option>
          <option>建议</option>
          <option>问题反馈</option>
        </select>
        <button class="btn btn-light px-3 py-1 text-sm">
          <i class="fa fa-refresh mr-1"></i> 刷新
        </button>
        <button class="btn btn-light px-3 py-1 text-sm">
          <i class="fa fa-download mr-1"></i> 导出
        </button>
      </div>

      <!-- 反馈列表 -->
      <div class="space-y-3">
        <div class="border border-gray-100 rounded-xl p-4 hover:shadow-sm transition-shadow" data-feedback-id="1">
          <div class="flex justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 bg-red-50 text-red-600 text-xs rounded-full">未处理</span>
              <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">申诉</span>
            </div>
            <span class="text-xs text-gray-400">2026-02-09 14:23</span>
          </div>
          <h3 class="text-sm font-medium mb-2">用户反馈访问 /image?path=xxx 被误拦，请求解封</h3>
          <div class="text-xs text-gray-500 mb-3">
            <p>用户ID：U20260209001 | IP：192.168.1.100 | 邮箱：user@example.com</p>
            <p>请求链接：/image?path=二次元/anime_001.webp | 错误码：403</p>
          </div>
          <p class="text-sm mb-3">反馈内容：我正常访问二次元分类图片时被系统误判为非法请求，请求管理员核实并解封，谢谢！</p>
          <div class="flex gap-2 justify-end">
            <button class="btn btn-light px-3 py-1 text-xs viewFeedbackBtn">查看详情</button>
            <button class="btn btn-light px-3 py-1 text-xs replyFeedbackBtn">回复用户</button>
            <button class="btn btn-light px-3 py-1 text-xs processFeedbackBtn">标记处理中</button>
            <button class="btn btn-success px-3 py-1 text-xs resolveFeedbackBtn">已处理</button>
            <button class="btn btn-danger px-3 py-1 text-xs rejectFeedbackBtn">驳回</button>
          </div>
        </div>

        <div class="border border-gray-100 rounded-xl p-4 hover:shadow-sm transition-shadow" data-feedback-id="2">
          <div class="flex justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">处理中</span>
              <span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full">建议</span>
            </div>
            <span class="text-xs text-gray-400">2026-02-08 10:15</span>
          </div>
          <h3 class="text-sm font-medium mb-2">建议增加更多二次元分类图片</h3>
          <div class="text-xs text-gray-500 mb-3">
            <p>用户ID：U20260208002 | IP：10.0.0.50 | 邮箱：suggest@example.com</p>
          </div>
          <p class="text-sm mb-3">反馈内容：目前二次元分类的图片数量较少，且分辨率大多偏低，建议增加更多2K/4K分辨率的高质量二次元壁纸。</p>
          <div class="flex gap-2 justify-end">
            <button class="btn btn-light px-3 py-1 text-xs viewFeedbackBtn">查看详情</button>
            <button class="btn btn-light px-3 py-1 text-xs replyFeedbackBtn">回复用户</button>
            <button class="btn btn-success px-3 py-1 text-xs resolveFeedbackBtn">已解决</button>
            <button class="btn btn-danger px-3 py-1 text-xs rejectFeedbackBtn">驳回</button>
          </div>
        </div>

        <div class="border border-gray-100 rounded-xl p-4 hover:shadow-sm transition-shadow" data-feedback-id="3">
          <div class="flex justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full">已解决</span>
              <span class="px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded-full">问题反馈</span>
            </div>
            <span class="text-xs text-gray-400">2026-02-07 09:08</span>
          </div>
          <h3 class="text-sm font-medium mb-2">部分图片加载速度过慢</h3>
          <div class="text-xs text-gray-500 mb-3">
            <p>用户ID：U20260207003 | IP：223.104.18.10 | 邮箱：feedback@example.com</p>
          </div>
          <p class="text-sm mb-3">反馈内容：访问/random接口获取图片时，部分图片加载时间超过3秒，希望能优化CDN加速。</p>
          <div class="flex gap-2 justify-end">
            <button class="btn btn-light px-3 py-1 text-xs viewFeedbackBtn">查看详情</button>
            <button class="btn btn-light px-3 py-1 text-xs reopenFeedbackBtn">重新处理</button>
          </div>
        </div>
      </div>

      <!-- 反馈分页 -->
      <div class="flex justify-between items-center mt-4 text-sm">
        <div class="text-gray-500">显示 1-3 条，共 18 条</div>
        <div class="flex gap-1">
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">«</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0 bg-blue-50 text-blue-600">1</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">2</button>
          <button class="btn btn-light w-8 h-8 flex items-center justify-center p-0">»</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- 上传弹窗 -->
<div id="modalUpload" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">上传图片</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center mb-4 upload-area" id="uploadArea">
      <i class="fa fa-cloud-upload text-3xl text-gray-300 mb-2"></i>
      <p class="text-sm text-gray-500">点击或拖拽上传</p>
      <p class="text-xs text-gray-400 mt-1">支持格式：jpg、png、webp | 单文件最大：5MB</p>
      <input type="file" multiple accept="image/*" class="hidden" id="fileInput">
    </div>
    <!-- 上传文件列表 -->
    <div id="uploadFileList" class="mb-4 hidden">
      <div class="text-sm font-medium mb-2">待上传文件 (2/10)</div>
      <div class="space-y-2 max-h-40 overflow-y-auto">
        <div class="flex items-center justify-between p-2 border border-gray-100 rounded-lg">
          <div class="flex items-center gap-2">
            <i class="fa fa-file-image-o text-blue-500"></i>
            <span class="text-xs">anime_004.webp</span>
          </div>
          <span class="text-xs text-gray-500">245KB</span>
          <button class="text-red-400 hover:text-red-600 removeUploadFile">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="flex items-center justify-between p-2 border border-gray-100 rounded-lg">
          <div class="flex items-center gap-2">
            <i class="fa fa-file-image-o text-blue-500"></i>
            <span class="text-xs">nature_130.jpg</span>
          </div>
          <span class="text-xs text-gray-500">320KB</span>
          <button class="text-red-400 hover:text-red-600 removeUploadFile">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- 分类选择 -->
    <div class="mb-4">
      <label class="text-sm text-gray-700 mb-1 block">选择分类</label>
      <select id="uploadCategorySelect" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
      </select>
    </div>
    <div class="flex justify-end gap-2">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="startUploadBtn">开始上传</button>
    </div>
  </div>
</div>

<!-- 图片查看弹窗 -->
<div id="modalViewImg" class="modal fixed inset-0 bg-black/80 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">图片详情</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <img src="https://picsum.photos/800/600?1" class="w-full rounded-lg object-contain" id="viewImgPreview">
      </div>
      <div class="space-y-3">
        <div>
          <h4 class="text-xs text-gray-500">基本信息</h4>
          <div class="mt-1 space-y-1 text-sm">
            <p><span class="text-gray-500">文件名：</span><span id="imgDetailFilename">加载中...</span></p>
            <p><span class="text-gray-500">文件大小：</span><span id="imgDetailSize">加载中...</span></p>
            <p><span class="text-gray-500">分辨率：</span><span id="imgDetailResolution">加载中...</span></p>
            <p><span class="text-gray-500">格式：</span><span id="imgDetailFormat">加载中...</span></p>
            <p><span class="text-gray-500">分类：</span><span id="imgDetailCategory">加载中...</span></p>
            <p><span class="text-gray-500">MD5：</span><span id="imgDetailMd5">加载中...</span></p>
          </div>
        </div>
        <div>
          <h4 class="text-xs text-gray-500">上传信息</h4>
          <div class="mt-1 space-y-1 text-sm">
            <p><span class="text-gray-500">上传时间：</span><span id="imgDetailUploadTime">加载中...</span></p>
            <p><span class="text-gray-500">上传者：</span><span id="imgDetailUploader">加载中...</span></p>
            <p><span class="text-gray-500">上传IP：</span><span id="imgDetailUploadIp">加载中...</span></p>
          </div>
        </div>
        <div>
          <h4 class="text-xs text-gray-500">访问统计</h4>
          <div class="mt-1 space-y-1 text-sm">
            <p><span class="text-gray-500">总访问量：</span><span id="imgDetailViewCount">加载中...</span></p>
            <p><span class="text-gray-500">最后访问：</span><span id="imgDetailLastViewed">加载中...</span></p>
          </div>
        </div>
        <div class="flex gap-2 mt-4">
          <button class="btn btn-primary flex-1 px-3 py-2 text-sm">
            <i class="fa fa-download mr-1"></i> 下载原图
          </button>
          <button class="btn btn-light flex-1 px-3 py-2 text-sm">
            <i class="fa fa-link mr-1"></i> 复制链接
          </button>
        </div>
        <div class="flex gap-2 mt-2">
          <button class="btn btn-secondary flex-1 px-3 py-2 text-sm" id="btnUpdateInfo">
            <i class="fa fa-edit mr-1"></i> 更新信息
          </button>
          <button class="btn btn-danger flex-1 px-3 py-2 text-sm" id="btnDeleteImage">
            <i class="fa fa-trash mr-1"></i> 删除
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 重命名弹窗 -->
<div id="modalRename" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">重命名图片</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-700 mb-1 block">原文件名</label>
        <input type="text" value="anime_001.webp" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50" readonly id="originalName">
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">新文件名</label>
        <input type="text" value="anime_001_new.webp" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="newName">
        <p class="text-xs text-gray-400 mt-1">提示：请勿修改文件扩展名，否则可能导致图片无法正常显示</p>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="confirmRenameBtn">确认重命名</button>
    </div>
  </div>
</div>

<!-- 移动弹窗 -->
<div id="modalMove" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">移动图片</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-700 mb-1 block">选中图片</label>
        <div class="bg-gray-50 p-2 rounded-lg text-sm" id="moveFileList">
          • anime_001.webp<br>• people_023.jpg
        </div>
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">目标分类</label>
        <select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="targetCategory">
          <option value="">请选择分类</option>
          <option value="anime">二次元</option>
          <option value="people">人物</option>
          <option value="nature">自然风光</option>
          <option value="wallpaper">壁纸</option>
          <option value="other">其他</option>
          <option value="new">创建新分类</option>
        </select>
        <!-- 新建分类输入框 -->
        <div class="mt-2 hidden" id="newCategoryInput">
          <input type="text" placeholder="输入新分类名称" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
        </div>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="confirmMoveBtn">确认移动</button>
    </div>
  </div>
</div>

<!-- 删除确认弹窗 -->
<div id="modalDelete" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认删除</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-exclamation-triangle text-4xl text-yellow-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要删除选中的图片吗？</p>
      <p class="text-xs text-red-500 mt-1">删除后将无法恢复，请谨慎操作！</p>
    </div>
    <div class="bg-gray-50 p-2 rounded-lg text-sm mb-4" id="deleteFileList">
      • anime_001.webp<br>• people_023.jpg
    </div>
    <div class="flex justify-end gap-2">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-danger px-4 py-2" id="confirmDeleteBtn">确认删除</button>
    </div>
  </div>
</div>

<!-- 更新图片信息弹窗 -->
<div id="modalUpdateInfo" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">更新图片信息</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-700 mb-1 block">图片名称</label>
        <input type="text" placeholder="请输入图片名称" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="updateFileName">
        <p class="text-xs text-gray-400 mt-1">提示：只能修改文件名，后缀将保持不变</p>
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">分类</label>
        <select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="updateCategorySelect">
          <option value="">请选择分类</option>
        </select>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="confirmUpdateBtn">确认更新</button>
    </div>
  </div>
</div>

<!-- 反馈详情弹窗 -->
<div id="modalFeedbackDetail" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">反馈详情</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div class="flex flex-wrap gap-2">
        <span class="px-2 py-0.5 bg-red-50 text-red-600 text-xs rounded-full">未处理</span>
        <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">申诉</span>
        <span class="px-2 py-0.5 bg-gray-50 text-gray-600 text-xs rounded-full">2026-02-09 14:23</span>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-1">反馈标题</h4>
        <p class="text-sm">用户反馈访问 /image?path=xxx 被误拦，请求解封</p>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-1">用户信息</h4>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <p><span class="text-gray-500">用户ID：</span>U20260209001</p>
          <p><span class="text-gray-500">IP地址：</span>192.168.1.100</p>
          <p><span class="text-gray-500">邮箱：</span>user@example.com</p>
          <p><span class="text-gray-500">设备：</span>Chrome/Windows 10</p>
        </div>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-1">请求信息</h4>
        <div class="bg-gray-50 p-3 rounded-lg text-sm">
          <p>请求链接：/image?path=二次元/anime_001.webp</p>
          <p>请求方法：GET</p>
          <p>错误码：403 Forbidden</p>
          <p>拦截原因：系统检测到疑似路径穿越攻击</p>
          <p>请求时间：2026-02-09 14:20:15</p>
        </div>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-1">反馈内容</h4>
        <div class="bg-gray-50 p-3 rounded-lg text-sm">
          我正常访问二次元分类图片时被系统误判为非法请求，请求管理员核实并解封，谢谢！这个图片是我常用的壁纸，没有任何违规内容。
        </div>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-1">回复用户</h4>
        <textarea class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm h-24" placeholder="输入回复内容..."></textarea>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">关闭</button>
      <button class="btn btn-light px-4 py-2">保存草稿</button>
      <button class="btn btn-primary px-4 py-2">发送回复</button>
      <button class="btn btn-success px-4 py-2">标记已处理</button>
    </div>
  </div>
</div>

<!-- 新建/编辑分类弹窗 -->
<div id="modalCategory" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold" id="categoryModalTitle">新建分类</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-700 mb-1 block">分类名称</label>
        <input type="text" placeholder="请输入分类名称" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="categoryName">
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">分类描述</label>
        <textarea class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm h-20" placeholder="请输入分类描述..." id="categoryDesc"></textarea>
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" id="categoryEnabled" checked class="rounded">
        <label for="categoryEnabled" class="text-sm text-gray-700">启用该分类</label>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="saveCategoryBtn">保存</button>
    </div>
  </div>
</div>

<!-- 删除分类确认弹窗 -->
<div id="modalDeleteCategory" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认删除</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-exclamation-triangle text-4xl text-yellow-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要删除选中的分类吗？</p>
      <p class="text-xs text-red-500 mt-1">删除后将无法恢复，请谨慎操作！</p>
    </div>
    <div class="bg-gray-50 p-2 rounded-lg text-sm mb-4" id="deleteCategoryName"></div>
    <div class="flex justify-end gap-2">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-danger px-4 py-2" id="confirmDeleteCategoryBtn">确认删除</button>
    </div>
  </div>
</div>

<!-- 添加/编辑用户弹窗 -->
<div id="modalUser" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold" id="userModalTitle">添加用户</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="text-sm text-gray-700 mb-1 block">用户名 *</label>
        <input type="text" placeholder="请输入用户名" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="userName">
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">邮箱 *</label>
        <input type="email" placeholder="请输入邮箱地址" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="userEmail">
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">密码</label>
        <input type="password" placeholder="留空则生成随机密码" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="userPassword">
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">用户类型</label>
        <select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="userType">
          <option value="normal">普通用户</option>
          <option value="vip">VIP用户</option>
          <option value="admin">管理员</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">用户状态</label>
        <select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" id="userStatus">
          <option value="active">活跃</option>
          <option value="pending">待审核</option>
          <option value="banned">已封禁</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-700 mb-1 block">备注</label>
        <textarea class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm h-20" placeholder="请输入备注信息..." id="userRemark"></textarea>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-primary px-4 py-2" id="saveUserBtn">保存</button>
    </div>
  </div>
</div>

<!-- 用户详情弹窗 -->
<div id="modalUserDetail" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">用户详情</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="space-y-4">
      <div class="flex flex-col items-center mb-4">
        <img src="https://ui-avatars.com/api/?name=张三&background=4169ff&color=fff&size=128" class="w-20 h-20 rounded-full mb-2" id="detailUserAvatar">
        <h4 class="text-lg font-semibold" id="detailUserName">张三</h4>
        <p class="text-gray-500 text-sm" id="detailUserEmail">zhangsan@example.com</p>
      </div>
      <div>
        <label class="text-xs text-gray-500 mb-1 block">用户ID</label>
        <p class="text-sm" id="detailUserId">U20260209001</p>
      </div>
      <div>
        <label class="text-xs text-gray-500 mb-1 block">用户类型</label>
        <p class="text-sm" id="detailUserType">普通用户</p>
      </div>
      <div>
        <label class="text-xs text-gray-500 mb-1 block">用户状态</label>
        <span class="inline-block px-2 py-1 rounded text-xs" id="detailUserStatusBadge">活跃</span>
      </div>
      <div>
        <label class="text-xs text-gray-500 mb-1 block">注册时间</label>
        <p class="text-sm" id="detailRegisterTime">2026-02-09</p>
      </div>
      <div>
        <label class="text-xs text-gray-500 mb-1 block">最后登录</label>
        <p class="text-sm" id="detailLastLoginIP">-</p>
      </div>
    </div>
    <div class="flex gap-2 mt-4">
      <button class="btn btn-warning flex-1 px-3 py-2 text-sm" id="banUnbanFromDetailBtn">
        <i class="fa fa-ban mr-1"></i> 封禁用户
      </button>
      <button class="btn btn-primary flex-1 px-3 py-2 text-sm" id="editFromDetailBtn">
        <i class="fa fa-edit mr-1"></i> 编辑
      </button>
      <button class="btn btn-danger flex-1 px-3 py-2 text-sm" id="deleteFromDetailBtn">
        <i class="fa fa-trash mr-1"></i> 删除
      </button>
    </div>
  </div>
</div>

<!-- 确认封禁用户弹窗 -->
<div id="modalBanUser" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认封禁</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-ban text-4xl text-orange-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要封禁该用户吗？</p>
      <p class="text-xs text-orange-500 mt-1">封禁后用户将无法登录系统</p>
    </div>
    <input type="hidden" id="banUserId">
    <div>
      <label class="text-sm text-gray-700 mb-1 block">封禁原因（可选）</label>
      <textarea class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm h-20" placeholder="请输入封禁原因..." id="banReason"></textarea>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-warning px-4 py-2" id="confirmBanUserBtn">确认封禁</button>
    </div>
  </div>
</div>

<!-- 确认解封用户弹窗 -->
<div id="modalUnbanUser" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认解封</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-check-circle text-4xl text-green-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要解封该用户吗？</p>
      <p class="text-xs text-green-500 mt-1">解封后用户可以正常登录</p>
    </div>
    <input type="hidden" id="unbanUserId">
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-success px-4 py-2" id="confirmUnbanUserBtn">确认解封</button>
    </div>
  </div>
</div>

<!-- 确认删除用户弹窗 -->
<div id="modalDeleteUser" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认删除</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-exclamation-triangle text-4xl text-red-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要删除该用户吗？</p>
      <p class="text-xs text-red-500 mt-1">删除后将无法恢复，请谨慎操作！</p>
    </div>
    <input type="hidden" id="deleteUserId">
    <div class="flex justify-end gap-2 mt-4">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-danger px-4 py-2" id="confirmDeleteUserBtn">确认删除</button>
    </div>
  </div>
</div>

<!-- 批量删除用户确认弹窗 -->
<div id="modalBatchDeleteUsers" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认批量删除</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-exclamation-triangle text-4xl text-yellow-500 mb-2"></i>
      <p class="text-sm text-gray-700">你确定要删除选中的 <span class="font-semibold text-red-500" id="batchDeleteCount">0</span> 个用户吗？</p>
      <p class="text-xs text-red-500 mt-1">删除后将无法恢复，请谨慎操作！</p>
    </div>
    <div class="bg-gray-50 p-2 rounded-lg text-sm mb-4 max-h-32 overflow-y-auto" id="batchDeleteUserList">
      <!-- 用户列表将在这里动态生成 -->
    </div>
    <div class="flex justify-end gap-2">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-danger px-4 py-2" id="confirmBatchDeleteUsersBtn">确认删除</button>
    </div>
  </div>
</div>

<!-- 删除分类确认弹窗 -->
<div id="modalDeleteCategory" class="modal fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold">确认删除分类</h3>
      <button class="closeModal text-gray-400 hover:text-gray-700">
        <i class="fa fa-times"></i>
      </button>
    </div>
    <div class="text-center mb-4">
      <i class="fa fa-exclamation-triangle text-4xl text-yellow-500 mb-2"></i>
      <p class="text-sm text-gray-700">确定要删除分类 <span class="font-semibold" id="deleteCategoryNameSpan">二次元</span> 吗？</p>
      <p class="text-xs text-red-500 mt-1">该分类下的 <span class="font-semibold" id="deleteCategoryCountSpan">1,258</span> 张图片将被移动到"其他"分类</p>
    </div>
    <div class="flex justify-end gap-2">
      <button class="closeModal btn btn-light px-4 py-2">取消</button>
      <button class="btn btn-danger px-4 py-2" id="confirmDeleteCategoryBtn">确认删除</button>
    </div>
  </div>
</div>

<!-- 提示弹窗 -->
<div id="toast" class="toast fixed top-20 right-6 bg-green-50 border border-green-200 text-green-700 px-4 py-2 rounded-lg shadow-lg flex items-center z-50 hidden">
  <i class="fa fa-check-circle mr-2"></i>
  <span id="toastText">操作成功！</span>
</div>

<script>
  // 基础API URL
  const API_BASE_URL = 'api';

  // 系统时区配置
  let systemTimezone = 'Asia/Shanghai'; // 默认时区

  // 获取系统时区配置
  async function getSystemTimezone() {
    try {
      const response = await fetch('/api/system/timezone');
      const data = await response.json();
      if (data.code === 200 && data.data && data.data.timezone) {
        systemTimezone = data.data.timezone;
        console.log('✅ 系统时区获取成功:', systemTimezone);
      }
    } catch (error) {
      console.error('❌ 获取系统时区失败:', error);
      // 使用默认时区
    }
  }

  // 获取系统基本信息，包括站点名称
  async function getSystemInfo() {
    try {
      const response = await fetch('/api/system/info');
      const data = await response.json();
      if (data.code === 200 && data.data && data.data.site_name) {
        document.title = data.data.site_name + ' - 管理后台';
        console.log('✅ 系统基本信息获取成功:', data.data.site_name);
      }
    } catch (error) {
      console.error('❌ 获取系统基本信息失败:', error);
      // 使用默认标题
    }
  }

  // 获取系统配置
  async function getSystemConfig() {
    try {
      const response = await fetch('/api/admin/system/config');
      const data = await response.json();
      if (data.code === 200 && data.data) {
        const config = data.data;
        
        // 更新页面标题和导航栏中的站点名称
        updateSiteNameFromConfig(config);
        
        // 填充基本设置
        if (config.site_name) {
          document.getElementById('siteName').value = config.site_name.value;
        }
        if (config.site_domain) {
          document.getElementById('siteDomain').value = config.site_domain.value;
        }
        if (config.icp_beian) {
          document.getElementById('icpBeian').value = config.icp_beian.value;
        }
        if (config.beian_link) {
          document.getElementById('beianLink').value = config.beian_link.value;
        }
        if (config.timezone) {
          document.getElementById('timezone').value = config.timezone.value;
        }
        if (config.favicon_url) {
          document.getElementById('faviconUrl').value = config.favicon_url.value;
        }
        
        // 填充安全设置
        if (config.enable_access_log) {
          document.getElementById('enableAccessLog').checked = config.enable_access_log.value === 'true';
        }
        if (config.show_beian_info) {
          document.getElementById('showBeianInfo').checked = config.show_beian_info.value === 'true';
        }
        if (config.enable_path_traversal_protection) {
          document.getElementById('enablePathTraversalProtection').checked = config.enable_path_traversal_protection.value === 'true';
        }
        if (config.enable_hotlink_protection) {
          document.getElementById('enableHotlinkProtection').checked = config.enable_hotlink_protection.value === 'true';
        }
        if (config.enable_ip_blacklist) {
          document.getElementById('enableIpBlacklist').checked = config.enable_ip_blacklist.value === 'true';
        }
        
        console.log('✅ 系统配置获取成功');
      }
    } catch (error) {
      console.error('❌ 获取系统配置失败:', error);
    }
  }

  // 保存系统配置
  async function saveSystemConfig() {
    try {
      // 构建配置数据
      const configs = [
        // 基本设置
        { key: 'site_name', value: document.getElementById('siteName').value },
        { key: 'site_domain', value: document.getElementById('siteDomain').value },
        { key: 'icp_beian', value: document.getElementById('icpBeian').value },
        { key: 'beian_link', value: document.getElementById('beianLink').value },
        { key: 'timezone', value: document.getElementById('timezone').value },
        { key: 'favicon_url', value: document.getElementById('faviconUrl').value },
        
        // 安全设置
        { key: 'enable_access_log', value: document.getElementById('enableAccessLog').checked ? 'true' : 'false' },
        { key: 'show_beian_info', value: document.getElementById('showBeianInfo').checked ? 'true' : 'false' },
        { key: 'enable_path_traversal_protection', value: document.getElementById('enablePathTraversalProtection').checked ? 'true' : 'false' },
        { key: 'enable_hotlink_protection', value: document.getElementById('enableHotlinkProtection').checked ? 'true' : 'false' },
        { key: 'enable_ip_blacklist', value: document.getElementById('enableIpBlacklist').checked ? 'true' : 'false' }
      ];
      
      // 逐个保存配置
      let allSuccess = true;
      for (const config of configs) {
        const response = await fetch('/api/admin/system/config', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(config)
        });
        
        const data = await response.json();
        if (data.code !== 200) {
          allSuccess = false;
          console.error(`❌ 保存配置 ${config.key} 失败:`, data.msg);
        }
      }
      
      if (allSuccess) {
        showToast('设置保存成功', 'success');
        console.log('✅ 所有系统配置保存成功');
      } else {
        showToast('部分设置保存失败', 'error');
      }
    } catch (error) {
      console.error('❌ 保存系统配置失败:', error);
      showToast('保存设置失败', 'error');
    }
  }

  // 重置为默认设置
  async function resetToDefaultSettings() {
    try {
      const response = await fetch('/api/admin/system/config/reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      if (data.code === 200) {
        // 重置成功后，重新获取系统配置并更新表单
        await getSystemConfig();
        showToast('已重置为默认设置', 'success');
        console.log('✅ 系统配置已重置为默认值');
      } else {
        showToast('重置默认设置失败', 'error');
        console.error('❌ 重置系统配置失败:', data.msg);
      }
    } catch (error) {
      console.error('❌ 重置系统配置失败:', error);
      showToast('重置默认设置失败', 'error');
    }
  }

  // 根据时区格式化时间
  function formatTimeWithTimezone(dateString, options = {}) {
    if (!dateString) return '-';
    
    try {
      // 处理非标准时间格式
      let normalizedDateString = dateString;
      
      // 如果是 "YYYY-MM-DD HH:MM:SS" 格式，转换为 "YYYY-MM-DDTHH:MM:SS" 格式
      if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(dateString)) {
        normalizedDateString = dateString.replace(' ', 'T');
      }
      
      // 如果是 "YYYY-MM-DD" 格式，添加时间部分
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
        normalizedDateString = dateString + 'T00:00:00';
      }
      
      const date = new Date(normalizedDateString);
      // 确保时间是有效的
      if (isNaN(date.getTime())) {
        console.error('❌ 无效的时间字符串:', dateString);
        return dateString;
      }
      
      const defaultOptions = {
        timeZone: systemTimezone,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      
      const mergedOptions = { ...defaultOptions, ...options };
      return new Intl.DateTimeFormat('zh-CN', mergedOptions).format(date);
    } catch (error) {
      console.error('❌ 时间格式化失败:', error);
      return dateString;
    }
  }

  // 根据时区格式化日期
  function formatDateWithTimezone(dateString) {
    return formatTimeWithTimezone(dateString, {
      timeZone: systemTimezone,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  }

  // 从后端API获取最新版本信息和更新日志
  async function loadGitHubVersionInfo() {
    try {
      // 从后端API获取版本信息，使用统一的check-update API
      const response = await fetch('/api/system/check-update', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      if (data.code === 200) {
        // 更新最新版本信息
        const latestVersionElement = document.getElementById('latestVersion');
        const latestVersionDateElement = document.getElementById('latestVersionDate');
        if (latestVersionElement && latestVersionDateElement) {
          latestVersionElement.textContent = data.data.latest_version || '未知';
          latestVersionDateElement.textContent = `发布于: ${data.data.latest_version_date || '未知'}`;
        }
        
        // 生成更新日志HTML
        const changelogElement = document.getElementById('changelogContent');
        if (changelogElement) {
          let releasesHtml = '';
          
          // 使用后端返回的完整changelog数据
          if (data.data.changelog && data.data.changelog.length > 0) {
            data.data.changelog.forEach((release, index) => {
              const publishDate = release.date || '未知';
              const version = release.version || '未知版本';
              const changes = release.changes || ['无更新说明'];
              
              let updates = '';
              changes.forEach(change => {
                if (change.trim()) {
                  updates += `<li class="ml-6 text-sm font-normal text-gray-600 dark:text-gray-400">• ${change.trim()}</li>`;
                }
              });
              
              releasesHtml += `
                <div class="border-l-4 ${index === 0 ? 'border-primary' : 'border-gray-300'} pl-4 py-2 mb-4">
                  <div class="flex justify-between items-center mb-1">
                    <h5 class="text-xl font-bold ${index === 0 ? 'text-primary dark:text-primary' : 'text-gray-700 dark:text-gray-300'}">${version} <span class="text-base font-normal text-gray-500 dark:text-gray-400">· ${publishDate}</span></h5>
                    ${index === 0 ? '<span class="badge badge-primary">最新</span>' : ''}
                  </div>
                  <ul class="text-muted-dark dark:text-muted-light space-y-2">
                    ${updates}
                  </ul>
                </div>
              `;
            });
          } else {
            // 如果没有更新日志数据，显示默认提示
            releasesHtml = `
              <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-info-circle text-4xl mb-4"></i>
                <p>暂无更新日志</p>
                <p class="mt-2 text-sm">更新日志将从GitHub获取</p>
              </div>
            `;
          }
          
          changelogElement.innerHTML = releasesHtml;
        }
        
        // 检查版本更新并控制更新按钮状态
        const currentVersion = document.getElementById('currentVersion').textContent;
        checkVersionUpdate({
          current_version: currentVersion,
          latest_version: data.data.latest_version
        });
      }
    } catch (error) {
      console.error('加载GitHub版本信息失败:', error);
      // 失败时显示错误提示框
      const latestVersion = document.getElementById('latestVersion');
      const latestVersionDate = document.getElementById('latestVersionDate');
      if (latestVersion) latestVersion.textContent = '加载失败';
      if (latestVersionDate) latestVersionDate.textContent = '加载失败';
      
      const changelogContent = document.getElementById('changelogContent');
      if (changelogContent) {
        changelogContent.innerHTML = `
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 text-center">
            <div class="text-yellow-600 dark:text-yellow-400 font-medium mb-2">
              <i class="fas fa-exclamation-triangle mr-2"></i>加载更新日志失败
            </div>
            <div class="text-gray-600 dark:text-gray-400 text-sm mb-3">
              暂时无法获取GitHub Releases数据
            </div>
            <a href="https://github.com/YunJian101/Random-Pictures/releases" target="_blank"
               class="inline-flex items-center px-4 py-2 bg-primary text-black dark:text-white rounded-lg hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg">
              <i class="fab fa-github mr-2"></i>前往 GitHub Releases 查看
            </a>
          </div>
        `;
      }
      
      // 检查版本更新并控制更新按钮状态
      const currentVersion = document.getElementById('currentVersion').textContent;
      checkVersionUpdate({
        current_version: currentVersion,
        latest_version: '加载失败'
      });
    }
  }

  // 加载版本信息
  async function loadVersionInfo() {
    try {
      // 开始加载时显示"加载中..."
      const currentVersionElement = document.getElementById('currentVersion');
      const currentVersionDateElement = document.getElementById('currentVersionDate');
      const latestVersionElement = document.getElementById('latestVersion');
      const latestVersionDateElement = document.getElementById('latestVersionDate');
      const changelogElement = document.getElementById('changelogContent');
      
      if (currentVersionElement) currentVersionElement.textContent = '加载中...';
      if (currentVersionDateElement) currentVersionDateElement.textContent = '加载中...';
      if (latestVersionElement) latestVersionElement.textContent = '加载中...';
      if (latestVersionDateElement) latestVersionDateElement.textContent = '加载中...';
      if (changelogElement) {
        changelogElement.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>加载中...</p>
            <p class="mt-2 text-sm">正在获取更新日志</p>
          </div>
        `;
      }
      
      // 从新的版本信息API获取本地版本信息
      const response = await fetch('/api/system/version', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      if (data.code === 200) {
        // 更新当前版本信息
        if (currentVersionElement && currentVersionDateElement) {
          currentVersionElement.textContent = data.data.version || '未知';
          currentVersionDateElement.textContent = `发布于: ${data.data.version_date || '未知'}`;
        }
        
        // 从GitHub获取最新版本信息和更新日志
        await loadGitHubVersionInfo();
      } else {
        console.error('获取版本信息失败:', data.msg);
        showToast('获取版本信息失败');
        // 失败时显示"加载失败"
        if (currentVersionElement) currentVersionElement.textContent = '加载失败';
        if (currentVersionDateElement) currentVersionDateElement.textContent = '加载失败';
        
        // 尝试从GitHub获取最新版本信息
        await loadGitHubVersionInfo();
      }
    } catch (error) {
      console.error('加载版本信息失败:', error);
      showToast('获取版本信息失败');
      // 失败时显示"加载失败"
      const currentVersionElement = document.getElementById('currentVersion');
      const currentVersionDateElement = document.getElementById('currentVersionDate');
      if (currentVersionElement) currentVersionElement.textContent = '加载失败';
      if (currentVersionDateElement) currentVersionDateElement.textContent = '加载失败';
      
      // 尝试从GitHub获取最新版本信息
      await loadGitHubVersionInfo();
    } finally {
      // 加载备份列表
      await loadBackupList();
    }
  }

  // 当前图片页码
  let currentImagePage = 1;
  
  // 分类管理相关变量
  let currentEditingCategory = null;
  let currentEditingCategoryId = null;
  let currentDeletingCategoryId = null;

  // ==================== API加载函数 ====================
  async function loadImagesFromAPI(page = 1, category = '') {
    try {
      // 构建API请求URL，支持分类过滤
      let url = `${API_BASE_URL}/images?page=${page}`;
      if (category) {
        url += `&category=${encodeURIComponent(category)}`;
      }
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      renderImages(data);
    } catch (error) {
      console.error('加载图片数据失败:', error);
      showToast('加载图片数据失败');
    }
  }

  // 加载所有分类数据（支持分页）
  async function loadAllCategories() {
    console.log('开始加载所有分类数据...');
    let allCategories = [];
    let currentPage = 1;
    let hasMoreData = true;
    
    try {
      while (hasMoreData) {
        const response = await fetch(`${API_BASE_URL}/categories?page=${currentPage}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`加载第 ${currentPage} 页分类数据成功:`, data);
        
        // 检查是否有分类数据
        if (data.category_list && data.category_list.length > 0) {
          allCategories = [...allCategories, ...data.category_list];
          currentPage++;
          // 假设如果返回的分类数量少于每页预期数量，则认为没有更多数据
          // 这里简单处理，实际应该根据API返回的分页信息判断
          if (data.category_list.length < 10) { // 假设每页最多10个分类
            hasMoreData = false;
          }
        } else {
          hasMoreData = false;
        }
      }
      
      console.log('所有分类数据加载完成，共', allCategories.length, '个分类');
      return {
        category_list: allCategories
      };
    } catch (error) {
      console.error('加载所有分类数据失败:', error);
      throw error;
    }
  }

  async function loadCategoriesFromAPI() {
    console.log('开始加载分类数据...');
    try {
      const data = await loadAllCategories();
      console.log('分类数据加载成功:', data);
      renderCategories(data);
      populateCategorySelects(data);
      // 将分类数据存储到localStorage中，以便在更新信息模态框中使用
      localStorage.setItem('categories', JSON.stringify(data.category_list));
      console.log('分类数据渲染、填充和存储完成');
      return data;
    } catch (error) {
      console.error('加载分类数据失败:', error);
      showToast('加载分类数据失败');
      return { category_list: [] };
    }
  }

  function renderImages(data) {
    const tbody = document.getElementById('imageTableBody');
    if (!tbody) return;

    if (!data.images || data.images.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">暂无图片数据</td></tr>';
      return;
    }

    tbody.innerHTML = data.images.map(img => `
      <tr class="table-row border-b border-gray-50 cursor-pointer hover:bg-gray-50" data-id="${img.id}" data-path="${img.path}">
        <td class="py-3 px-2"><input type="checkbox" class="rounded imgCheckbox"></td>
        <td class="py-3 px-2">
          <img src="${img.url}" class="w-12 h-12 rounded object-cover imgPreview" alt="${img.name}">
        </td>
        <td class="py-3 px-2">${img.name}</td>
        <td class="py-3 px-2">${img.category}</td>
        <td class="py-3 px-2">${formatFileSize(img.size_bytes)}</td>
        <td class="py-3 px-2">${img.resolution}</td>
        <td class="py-3 px-2 text-gray-500">${formatTimeWithTimezone(img.modified_time)}</td>
      </tr>
    `).join('');

    // 为每个图片行添加点击事件监听器，点击时显示图片详情
    document.querySelectorAll('#imageTableBody tr').forEach(row => {
      row.addEventListener('click', function(e) {
        // 避免点击复选框时触发行点击事件
        if (e.target.type === 'checkbox' || e.target.closest('input[type="checkbox"]')) {
          return;
        }
        
        const imgId = this.dataset.id;
        const imgPreview = this.querySelector('.imgPreview');
        const modalViewImg = document.getElementById('modalViewImg');
        
        // 存储图片ID到模态框的dataset中
        modalViewImg.dataset.imgId = imgId;
        modalViewImg.style.display = 'flex';
        
        if (imgPreview) {
          document.getElementById('viewImgPreview').src = imgPreview.src.replace('64/64', '800/600');
        }
        
        // 从API获取图片详情
        fetch(`${API_BASE_URL}/image/${imgId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.code === 200 && data.data) {
              const imgData = data.data;
              // 更新模态框中的数据
              document.getElementById('imgDetailFilename').textContent = imgData.filename;
              document.getElementById('imgDetailSize').textContent = formatFileSize(imgData.file_size);
              document.getElementById('imgDetailResolution').textContent = `${imgData.width}×${imgData.height}`;
              document.getElementById('imgDetailFormat').textContent = imgData.format;
              document.getElementById('imgDetailCategory').textContent = imgData.category_name;
              document.getElementById('imgDetailMd5').textContent = imgData.md5;
              document.getElementById('imgDetailUploadTime').textContent = formatTimeWithTimezone(imgData.upload_time);
              document.getElementById('imgDetailUploader').textContent = imgData.uploader;
              document.getElementById('imgDetailUploadIp').textContent = imgData.upload_ip;
              document.getElementById('imgDetailViewCount').textContent = imgData.view_count;
              document.getElementById('imgDetailLastViewed').textContent = imgData.last_viewed_at ? formatTimeWithTimezone(imgData.last_viewed_at) : '从未访问';
            } else {
              showToast('获取图片详情失败');
            }
          })
          .catch(error => {
            console.error('获取图片详情失败:', error);
            showToast('获取图片详情失败');
          });
      });
    });

    
  }

  function renderCategories(data) {
    const grid = document.getElementById('categoryGrid');
    if (!grid) return;

    if (!data.category_list || data.category_list.length === 0) {
      grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">暂无分类数据</div>';
      return;
    }

    // 定义分类图标和颜色映射
    const categoryStyles = {
      'default': {
        icon: 'fa-folder',
        gradient: 'from-gray-500 to-gray-400'
      }
    };

    grid.innerHTML = data.category_list.map((category, index) => {
      const style = categoryStyles['default'];
      const statusClass = category.status === 'enabled' ? 'bg-green-50 text-green-600' : 'bg-gray-100 text-gray-500';
      const statusText = category.status === 'enabled' ? '启用' : '禁用';
      const opacityClass = category.status === 'enabled' ? '' : 'opacity-60';

      return `
        <div class="border border-gray-100 rounded-xl p-4 hover:shadow-sm transition-shadow ${opacityClass}">
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br ${style.gradient} flex items-center justify-center">
                <i class="fa ${style.icon} text-white text-lg"></i>
              </div>
              <div>
                <h3 class="font-medium">${category.name}</h3>
                <p class="text-xs text-gray-400">0 张图片</p>
              </div>
            </div>
            <span class="px-2 py-0.5 ${statusClass} text-xs rounded-full">${statusText}</span>
          </div>
          <div class="text-xs text-gray-500 mb-3">描述：${category.description || category.name}分类</div>
          <div class="flex gap-2">
            <button class="btn btn-light flex-1 px-2 py-1 text-xs editCategoryBtn" data-category="${category.name}" data-category-id="${category.id}">
              <i class="fa fa-pencil mr-1"></i> 编辑
            </button>
            <button class="btn btn-light px-2 py-1 text-xs">
              <i class="fa fa-eye"></i>
            </button>
            <button class="btn btn-light px-2 py-1 text-xs text-red-500 deleteCategoryBtn" data-category="${category.name}" data-category-id="${category.id}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');

    // 绑定分类事件
    bindCategoryActionEvents();
  }
  function bindCategoryActionEvents() {
    // 编辑分类
    document.querySelectorAll('.editCategoryBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const name = this.dataset.category;
        const id = this.dataset.categoryId;
        document.getElementById('categoryModalTitle').textContent = '编辑分类';
        document.getElementById('categoryName').value = name;
        document.getElementById('categoryDesc').value = '';
        
        // 存储当前编辑的分类名称和ID，用于后续更新操作
        currentEditingCategory = name;
        currentEditingCategoryId = id;
        document.getElementById('modalCategory').style.display = 'flex';
      });
    });

    // 删除分类
    document.querySelectorAll('.deleteCategoryBtn').forEach(btn => {
      btn.addEventListener('click', function(event) {
        event.stopPropagation();
        const name = this.dataset.category;
        const id = this.dataset.categoryId;
        const card = this.closest('.border-gray-100');
        const count = card.querySelector('p.text-gray-400').textContent;
        document.getElementById('deleteCategoryNameSpan').textContent = name;
        document.getElementById('deleteCategoryCountSpan').textContent = count;
        
        // 存储当前删除的分类ID，用于后续删除操作
        currentDeletingCategoryId = id;
        document.getElementById('modalDeleteCategory').style.display = 'flex';
      });
    });
  }

  async function loadFeedbacksFromAPI() {
    try {
      const response = await fetch(`${API_BASE_URL}/admin/feedbacks`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const result = await response.json();
      if (result.code === 200) {
        renderFeedbacks(result.data.feedbacks);
      } else {
        showToast('加载反馈数据失败: ' + result.msg);
      }
    } catch (error) {
      console.error('加载反馈数据失败:', error);
      showToast('加载反馈数据失败');
    }
  }

  function renderFeedbacks(feedbacks) {
    const tbody = document.getElementById('feedbackTableBody');
    if (!tbody) return;

    if (!feedbacks || feedbacks.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="py-8 text-center text-gray-500">
            <i class="fa fa-comment-o text-4xl mb-2"></i>
            <p>暂无反馈数据</p>
          </td>
        </tr>
      `;
      return;
    }

    const statusMap = {
      'pending': { text: '待处理', class: 'bg-yellow-50 text-yellow-600' },
      'processing': { text: '处理中', class: 'bg-blue-50 text-blue-600' },
      'resolved': { text: '已解决', class: 'bg-green-50 text-green-600' },
      'closed': { text: '已关闭', class: 'bg-gray-100 text-gray-500' }
    };

    tbody.innerHTML = feedbacks.map(feedback => {
      const statusInfo = statusMap[feedback.status] || statusMap['pending'];
      const createdTime = formatTimeWithTimezone(feedback.created_at);
      const username = feedback.username || '未知用户';

      return `
        <tr class="border-b border-gray-100 hover:bg-gray-50" data-id="${feedback.id}">
          <td class="py-3 px-2">
            <input type="checkbox" class="rounded feedbackCheckbox" data-feedback-id="${feedback.id}">
          </td>
          <td class="py-3 px-2 font-mono text-sm text-gray-600">#${feedback.id}</td>
          <td class="py-3 px-2">${username}</td>
          <td class="py-3 px-2 max-w-xs truncate" title="${feedback.content}">${feedback.content}</td>
          <td class="py-3 px-2 text-gray-500">${createdTime}</td>
          <td class="py-3 px-2">
            <span class="px-2 py-0.5 ${statusInfo.class} text-xs rounded-full">${statusInfo.text}</span>
          </td>
          <td class="py-3 px-2">
            <div class="flex gap-1">
              <button class="text-blue-500 text-sm p-1 viewFeedbackBtn" title="查看详情" data-feedback-id="${feedback.id}">
                <i class="fa fa-eye"></i>
              </button>
              <button class="text-green-600 text-sm p-1 resolveFeedbackBtn" title="标记为已解决" data-feedback-id="${feedback.id}">
                <i class="fa fa-check"></i>
              </button>
              <button class="text-red-500 text-sm p-1 deleteFeedbackBtn" title="删除" data-feedback-id="${feedback.id}">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // 绑定反馈操作事件
    bindFeedbackActionEvents();
  }

  function bindFeedbackActionEvents() {
    // 查看反馈详情
    document.querySelectorAll('.viewFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const feedbackId = this.dataset.feedbackId;
        showToast('查看反馈详情功能待实现');
      });
    });

    // 标记为已解决
    document.querySelectorAll('.resolveFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const feedbackId = this.dataset.feedbackId;
        showToast('标记反馈功能待实现');
      });
    });

    // 删除反馈
    document.querySelectorAll('.deleteFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const feedbackId = this.dataset.feedbackId;
        showToast('删除反馈功能待实现');
      });
    });
  }

  function populateCategorySelects(data) {
    console.log('populateCategorySelects 被调用，数据:', data);

    const selects = [
      document.getElementById('uploadCategorySelect'),
      document.getElementById('imageCategoryFilter'),
      document.getElementById('updateCategorySelect')
    ];

    selects.forEach(select => {
      if (!select) {
        console.warn('找不到select元素');
        return;
      }
      console.log('正在填充select元素:', select.id);

      // 清空select元素
      select.innerHTML = '';
      
      // 为不同的select添加默认选项
      if (select.id === 'imageCategoryFilter') {
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = '全部分类';
        select.appendChild(allOption);
      } else if (select.id === 'updateCategorySelect') {
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '请选择分类';
        select.appendChild(defaultOption);
      }

      // 从 category_list 读取分类数据（数组格式）
      if (data.category_list && data.category_list.length > 0) {
        console.log(`找到 ${data.category_list.length} 个分类`);
        data.category_list.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          select.appendChild(option);
        });
        console.log(`成功添加了 ${data.category_list.length} 个分类选项到 ${select.id}`);
      } else {
        console.warn('category_list 为空或不存在');
        // 如果没有分类数据，添加一个提示选项
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '暂无分类数据';
        select.appendChild(option);
      }
    });
  }

  function bindImageActionEvents() {
    // 查看图片详情
    document.querySelectorAll('.viewImgBtn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const row = this.closest('tr');
        const imgId = row.dataset.id;
        const imgPreview = row.querySelector('.imgPreview');
        document.getElementById('modalViewImg').style.display = 'flex';
        
        if (imgPreview) {
          document.getElementById('viewImgPreview').src = imgPreview.src.replace('64/64', '800/600');
        }
        
        // 从API获取图片详情
        try {
          const response = await fetch(`${API_BASE_URL}/image/${imgId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          if (data.code === 200 && data.data) {
            const imgData = data.data;
            // 更新模态框中的数据
            document.getElementById('imgDetailFilename').textContent = imgData.filename;
              document.getElementById('imgDetailSize').textContent = formatFileSize(imgData.file_size);
              document.getElementById('imgDetailResolution').textContent = `${imgData.width}×${imgData.height}`;
            document.getElementById('imgDetailFormat').textContent = imgData.format;
            document.getElementById('imgDetailCategory').textContent = imgData.category_name;
            document.getElementById('imgDetailMd5').textContent = imgData.md5;
            document.getElementById('imgDetailUploadTime').textContent = formatTimeWithTimezone(imgData.upload_time);
            document.getElementById('imgDetailUploader').textContent = imgData.uploader;
            document.getElementById('imgDetailUploadIp').textContent = imgData.upload_ip;
            document.getElementById('imgDetailViewCount').textContent = imgData.view_count;
            document.getElementById('imgDetailLastViewed').textContent = imgData.last_viewed_at ? formatTimeWithTimezone(imgData.last_viewed_at) : '从未访问';
          } else {
            showToast('获取图片详情失败');
          }
        } catch (error) {
          console.error('获取图片详情失败:', error);
          showToast('获取图片详情失败');
        }
      });
    });

    // 删除图片
    document.querySelectorAll('.deleteImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        showToast('删除功能待实现');
      });
    });

    // 重命名图片
    document.querySelectorAll('.renameImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        const fileName = row.querySelector('td:nth-child(4)').textContent;
        document.getElementById('modalRename').style.display = 'flex';
        document.getElementById('originalName').value = fileName;
        document.getElementById('newName').value = fileName.replace('.', '_new.');
      });
    });

    // 移动图片
    document.querySelectorAll('.moveImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        showToast('移动功能待实现');
      });
    });

    // 下载图片
    document.querySelectorAll('.downloadImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        showToast('下载功能待实现');
      });
    });
  }

  // ==================== 通用函数 ====================
  // 通用关闭弹窗函数
  function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });
    document.getElementById('toast').style.display = 'none';
    
    // 重置所有文件输入元素，解决上传功能第二次无法使用的问题
    document.querySelectorAll('input[type="file"]').forEach(fileInput => {
      fileInput.value = '';
    });
    
    // 隐藏上传文件列表
    const uploadFileList = document.getElementById('uploadFileList');
    const mainUploadList = document.getElementById('mainUploadList');
    if (uploadFileList) {
      uploadFileList.style.display = 'none';
    }
    if (mainUploadList) {
      mainUploadList.style.display = 'none';
    }
    
    // 隐藏上传设置
    const mainUploadSettings = document.getElementById('mainUploadSettings');
    if (mainUploadSettings) {
      mainUploadSettings.style.display = 'none';
    }
  }

  // 显示提示框
  function showToast(text) {
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    toastText.textContent = text;
    toast.style.display = 'flex';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }

  // 格式化文件大小函数
  function formatFileSize(bytes) {
    if (bytes < 1024) {
      return bytes + 'B';
    } else if (bytes < 1024 * 1024) {
      return Math.floor(bytes / 1024) + 'KB';
    } else {
      // 计算MB值
      const mb = bytes / (1024 * 1024);
      // 格式化显示：如果是整数，显示为整数MB；如果有小数，显示到小数点后两位，去掉末尾的0
      if (Number.isInteger(mb)) {
        return mb + 'MB';
      } else {
        // 先格式化到小数点后两位
        let formatted = mb.toFixed(2);
        // 去掉末尾的0和可能的小数点
        formatted = formatted.replace(/\.?0+$/, '');
        return formatted + 'MB';
      }
    }
  }

  // 初始化事件监听
  document.addEventListener('DOMContentLoaded', function() {
    // 页面加载时自动加载分类数据，用于填充所有分类下拉菜单
    loadCategoriesFromAPI();
    
    // 侧边栏菜单激活
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
      item.addEventListener('click', function() {
        sidebarItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');

        // 隐藏所有页面
        const sections = ['imgManageSection', 'uploadSection', 'categorySection', 'userSection', 'feedbackSection', 'settingSection', 'logSection', 'updateSection'];
        sections.forEach(section => {
          const element = document.getElementById(section);
          if (element) {
            element.style.display = 'none';
          }
        });

        // 根据菜单显示对应页面
        switch(this.id) {
          case 'menuImgManage':
            document.getElementById('imgManageSection').style.display = 'block';
            loadImagesFromAPI(); // 从后端API加载图片数据
            break;
          case 'menuUpload':
            document.getElementById('uploadSection').style.display = 'block';
            loadCategoriesFromAPI(); // 加载分类数据用于上传时选择
            break;
          case 'menuCategory':
            document.getElementById('categorySection').style.display = 'block';
            loadCategoriesFromAPI(); // 从后端API加载分类数据
            break;
          case 'menuUser':
            document.getElementById('userSection').style.display = 'block';
            loadUsersFromAPI(); // 从后端API加载用户数据
            break;
          case 'menuFeedback':
            document.getElementById('feedbackSection').style.display = 'block';
            loadFeedbacksFromAPI(); // 从后端API加载反馈数据
            break;
          case 'menuSetting':
            document.getElementById('settingSection').style.display = 'block';
            break;
          case 'menuLog':
            document.getElementById('logSection').style.display = 'block';
            break;
          case 'menuUpdate':
            document.getElementById('updateSection').style.display = 'block';
            loadVersionInfo(); // 从API加载版本信息
            break;
        }

        showToast(`已切换到${this.textContent.trim()}页面`);
      });
    });

    // 关闭弹窗按钮
    document.querySelectorAll('.closeModal').forEach(btn => {
      btn.addEventListener('click', closeAllModals);
    });

    // 点击空白处关闭弹窗
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeAllModals();
      });
    });
    
    // 分类过滤器变更事件
    const categoryFilter = document.getElementById('imageCategoryFilter');
    if (categoryFilter) {
      categoryFilter.addEventListener('change', function() {
        const selectedCategory = this.value;
        console.log('选择了分类:', selectedCategory);
        // 重新加载图片列表，应用分类过滤
        loadImagesFromAPI(1, selectedCategory);
      });
    }
    
    // 图片详情页面按钮事件
    const modalViewImg = document.getElementById('modalViewImg');
    if (modalViewImg) {
      // 更新信息按钮
      const btnUpdateInfo = document.getElementById('btnUpdateInfo');
      if (btnUpdateInfo) {
        btnUpdateInfo.addEventListener('click', function() {
          // 获取当前查看的图片ID
          const imgId = document.querySelector('#modalViewImg').dataset.imgId;
          if (imgId) {
            console.log('更新图片信息:', imgId);
            // 打开更新信息的模态框
            const modalUpdateInfo = document.getElementById('modalUpdateInfo');
            modalUpdateInfo.style.display = 'flex';
            
            // 设置图片ID到模态框
            modalUpdateInfo.dataset.imgId = imgId;
            
            // 填充当前图片信息
              const fileName = document.getElementById('imgDetailFilename').textContent;
              const categoryName = document.getElementById('imgDetailCategory').textContent;
              
              document.getElementById('updateFileName').value = fileName;
              
              // 尝试从API加载分类数据
              loadCategoriesFromAPI().then(() => {
                // 分类数据加载完成后，设置当前分类
                const updateCategorySelect = document.getElementById('updateCategorySelect');
                // 遍历所有分类，找到匹配的分类ID
                const categories = JSON.parse(localStorage.getItem('categories') || '[]');
                const currentCategory = categories.find(c => c.name === categoryName);
                if (currentCategory) {
                  // 设置当前分类
                  Array.from(updateCategorySelect.options).forEach(option => {
                    if (option.value == currentCategory.id) {
                      option.selected = true;
                    }
                  });
                }
              });
          } else {
            showToast('无法获取图片ID');
          }
        });
      }
      
      // 删除图片按钮
      const btnDeleteImage = document.getElementById('btnDeleteImage');
      if (btnDeleteImage) {
        btnDeleteImage.addEventListener('click', async function() {
          // 获取当前查看的图片ID
          const imgId = document.querySelector('#modalViewImg').dataset.imgId;
          if (imgId) {
            if (confirm('确定要删除这张图片吗？此操作不可恢复。')) {
              try {
                const response = await fetch(`${API_BASE_URL}/image/${imgId}`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.code === 200) {
                  showToast('图片删除成功');
                  // 关闭模态框
                  document.getElementById('modalViewImg').style.display = 'none';
                  // 重新加载图片列表
                  loadImagesFromAPI();
                } else {
                  showToast('图片删除失败: ' + (data.msg || '未知错误'));
                }
              } catch (error) {
                console.error('删除图片失败:', error);
                showToast('删除图片失败');
              }
            }
          } else {
            showToast('无法获取图片ID');
          }
        });
      }
      
      // 下载原图按钮
      const downloadBtn = modalViewImg.querySelector('.btn-primary');
      if (downloadBtn) {
        console.log('找到下载原图按钮:', downloadBtn);
        downloadBtn.addEventListener('click', function() {
          console.log('点击了下载原图按钮');
          // 获取当前查看的图片URL
          const imgUrl = document.getElementById('viewImgPreview').src;
          console.log('图片URL:', imgUrl);
          if (imgUrl) {
            // 创建下载链接
            const link = document.createElement('a');
            link.href = imgUrl;
            link.download = '';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('开始下载图片...');
          } else {
            showToast('无法获取图片URL');
          }
        });
      } else {
        console.error('未找到下载原图按钮');
      }
      
      // 复制链接按钮
      const copyLinkBtn = modalViewImg.querySelector('.btn-light');
      if (copyLinkBtn) {
        console.log('找到复制链接按钮:', copyLinkBtn);
        copyLinkBtn.addEventListener('click', function() {
          console.log('点击了复制链接按钮');
          // 获取当前查看的图片URL
          const imgUrl = document.getElementById('viewImgPreview').src;
          console.log('图片URL:', imgUrl);
          if (imgUrl) {
            // 复制到剪贴板
            if (navigator.clipboard) {
              navigator.clipboard.writeText(imgUrl)
                .then(() => {
                  console.log('复制成功');
                  showToast('链接已复制到剪贴板');
                })
                .catch(err => {
                  console.error('复制失败:', err);
                  showToast('复制链接失败');
                });
            } else {
              // 备用方案：创建临时输入框
              const textArea = document.createElement('textarea');
              textArea.value = imgUrl;
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand('copy');
                showToast('链接已复制到剪贴板');
              } catch (err) {
                console.error('复制失败:', err);
                showToast('复制链接失败');
              } finally {
                document.body.removeChild(textArea);
              }
            }
          } else {
            showToast('无法获取图片URL');
          }
        });
      } else {
        console.error('未找到复制链接按钮');
      }
    }

    // ==================== 上传页面功能 ====================
    // 主文件选择 (事件监听器已在DOMContentLoaded中绑定,这里只处理文件变化后的逻辑)
    const mainFileInput = document.getElementById('mainFileInput');
    if (mainFileInput) {
      mainFileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          const mainUploadList = document.getElementById('mainUploadList');
          const mainUploadSettings = document.getElementById('mainUploadSettings');
          if (mainUploadList && mainUploadSettings) {
            mainUploadList.style.display = 'block';
            mainUploadSettings.style.display = 'grid';
            renderUploadFileList(this.files);
            showToast(`已选择 ${this.files.length} 个文件`);
          }
        }
      });
    }

    // 渲染待上传文件列表
    function renderUploadFileList(files) {
      const container = document.getElementById('uploadFileListContainer');
      const fileCountSpan = document.getElementById('fileCount');

      if (!container || !fileCountSpan) return;

      container.innerHTML = '';
      fileCountSpan.textContent = `(${files.length}/10)`;

      Array.from(files).forEach((file, index) => {
        // 获取文件信息
        const fileSize = formatFileSize(file.size);
        const fileName = file.name;
        const fileExtension = fileName.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);

        // 生成预览URL
        const previewUrl = isImage ? URL.createObjectURL(file) : 'https://via.placeholder.com/40';

        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 border border-gray-100 rounded-lg hover:bg-gray-50';
        fileItem.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${previewUrl}" class="w-10 h-10 rounded object-cover" alt="${fileName}">
            <div>
              <div class="text-sm font-medium">${fileName}</div>
              <div class="text-xs text-gray-400">${fileSize}</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded-full">待上传</span>
            <button class="text-red-400 hover:text-red-600 removeMainUploadFile" data-index="${index}">
              <i class="fa fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(fileItem);
      });

      // 重新绑定删除按钮事件
      document.querySelectorAll('.removeMainUploadFile').forEach(btn => {
        btn.addEventListener('click', function() {
          const fileItem = this.closest('.border-gray-100');
          fileItem.remove();
          updateFileCount();
        });
      });
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) {
        return bytes + 'B';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(0) + 'KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(0) + 'MB';
      }
    }

    // 更新文件计数
    function updateFileCount() {
      const container = document.getElementById('uploadFileListContainer');
      const fileCountSpan = document.getElementById('fileCount');
      if (container && fileCountSpan) {
        const count = container.children.length;
        fileCountSpan.textContent = `(${count}/10)`;
      }
    }

    // 移除上传文件
    document.querySelectorAll('.removeMainUploadFile').forEach(btn => {
      btn.addEventListener('click', function() {
        const fileItem = this.closest('.border-gray-100');
        if (fileItem) {
          fileItem.remove();
          showToast('已移除该文件');
        }
      });
    });

    // 清空上传列表
    const clearUploadListBtn = document.getElementById('clearUploadListBtn');
    if (clearUploadListBtn) {
      clearUploadListBtn.addEventListener('click', function() {
        const uploadFileListContainer = document.getElementById('uploadFileListContainer');
        const mainUploadList = document.getElementById('mainUploadList');
        if (uploadFileListContainer && mainUploadList) {
          uploadFileListContainer.innerHTML = '';
          mainUploadList.style.display = 'none';
          showToast('已清空上传列表');
        }
      });
    }

    // 取消上传
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    if (cancelUploadBtn) {
      cancelUploadBtn.addEventListener('click', function() {
        const mainUploadList = document.getElementById('mainUploadList');
        if (mainUploadList) {
          mainUploadList.style.display = 'none';
          showToast('已取消上传');
        }
      });
    }

    // 开始主上传
    const startMainUploadBtn = document.getElementById('startMainUploadBtn');
    if (startMainUploadBtn) {
      startMainUploadBtn.addEventListener('click', async function() {
        const fileInput = document.getElementById('mainFileInput');
        const categorySelect = document.getElementById('uploadCategorySelect');
        
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          showToast('请先选择要上传的图片文件');
          return;
        }
        
        const category = categorySelect ? categorySelect.value : '根目录';
        const files = Array.from(fileInput.files);
        
        const progressArea = document.getElementById('uploadProgressArea');
        const progressBar = document.getElementById('uploadProgressBar');
        const progressText = document.getElementById('uploadProgressText');
        
        if (progressArea && progressBar && progressText) {
          progressArea.style.display = 'block';
          progressBar.style.width = '0%';
          progressText.textContent = '0%';
        }
        
        try {
          // 创建FormData
          const formData = new FormData();
          files.forEach(file => {
            formData.append('files', file);
          });
          formData.append('category', category);
          
          // 发送上传请求
          const response = await fetch('api/admin/upload', {
            method: 'POST',
            body: formData,
            credentials: 'include' // 包含cookies
          });
          
          const result = await response.json();
          
          if (result.code === 200) {
            // 上传成功
            if (progressBar && progressText) {
              progressBar.style.width = '100%';
              progressText.textContent = '100%';
            }
            
            setTimeout(() => {
              showToast(`上传成功！新增${result.data.uploaded_count}张图片`);
              if (progressArea) {
                progressArea.style.display = 'none';
              }
              const mainUploadList = document.getElementById('mainUploadList');
              const uploadFileListContainer = document.getElementById('uploadFileListContainer');
              if (mainUploadList) {
                mainUploadList.style.display = 'none';
              }
              if (uploadFileListContainer) {
                uploadFileListContainer.innerHTML = '';
              }
              
              // 重置文件输入元素
              fileInput.value = '';
              
              // 可选：刷新图片列表
              // loadImagesFromAPI();
            }, 500);
          } else {
            // 上传失败
            throw new Error(result.msg || '上传失败');
          }
          
        } catch (error) {
          console.error('上传错误:', error);
          showToast(`上传失败: ${error.message}`);
          if (progressArea) {
            progressArea.style.display = 'none';
          }
          
          // 重置文件输入元素
          fileInput.value = '';
        }
      });
    }

    // ==================== 分类管理功能 ====================
    // 新建分类
    document.getElementById('addCategoryBtn').addEventListener('click', function() {
      document.getElementById('categoryModalTitle').textContent = '新建分类';
      document.getElementById('categoryName').value = '';
      document.getElementById('categoryDesc').value = '';
      document.getElementById('modalCategory').style.display = 'flex';
    });

    // 保存分类
    document.getElementById('saveCategoryBtn').addEventListener('click', async function() {
      const name = document.getElementById('categoryName').value;
      const description = document.getElementById('categoryDesc').value;
      if (!name) {
        showToast('请输入分类名称');
        return;
      }
      
      try {
        let url = `${API_BASE_URL}/admin/categories`;
        let method = 'POST';
        
        // 如果是编辑分类，使用PUT方法和带ID的URL
        if (currentEditingCategoryId) {
          url = `${API_BASE_URL}/admin/categories/${currentEditingCategoryId}`;
          method = 'PUT';
        }
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, description })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.code === 200) {
          closeAllModals();
          showToast(`分类"${name}"保存成功！`);
          loadCategoriesFromAPI();
          // 重置编辑状态
          currentEditingCategory = null;
          currentEditingCategoryId = null;
        } else {
          showToast(`保存失败: ${result.msg}`);
        }
      } catch (error) {
        console.error('保存分类失败:', error);
        showToast('保存分类失败，请稍后重试');
      }
    });

    // 确认删除分类
    document.getElementById('confirmDeleteCategoryBtn').addEventListener('click', async function() {
      const categoryName = document.getElementById('deleteCategoryNameSpan').textContent;
      
      try {
        // 遍历所有分页查找分类ID
        let categoryId = null;
        let currentPage = 1;
        let totalPages = 1;
        
        do {
          const categoriesResponse = await fetch(`${API_BASE_URL}/categories?page=${currentPage}`);
          if (!categoriesResponse.ok) {
            throw new Error(`HTTP error! status: ${categoriesResponse.status}`);
          }

          const categoriesData = await categoriesResponse.json();
          totalPages = categoriesData.total_pages || 1;

          // 在当前页查找分类（新格式：category_list 数组）
          const foundCategory = categoriesData.category_list.find(cat => cat.name === categoryName);
          if (foundCategory) {
            categoryId = foundCategory.id;
            break;
          }

          currentPage++;
        } while (currentPage <= totalPages);
        
        if (!categoryId) {
          throw new Error('找不到分类ID');
        }
        
        const response = await fetch(`${API_BASE_URL}/admin/categories/${categoryId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.code === 200) {
          closeAllModals();
          showToast('分类删除成功！');
          loadCategoriesFromAPI();
        } else {
          showToast(`删除失败: ${result.msg}`);
        }
      } catch (error) {
        console.error('删除分类失败:', error);
        showToast('删除分类失败，请稍后重试');
      }
    });

    // ==================== 系统设置功能 ====================
    // 保存设置
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
      showToast('系统设置保存成功！');
    });

    // ==================== 图片上传弹窗 (原有功能) ====================
    const modalUpload = document.getElementById('modalUpload');
    document.getElementById('btnUploadMain').addEventListener('click', async () => {
      // 打开弹窗前先加载最新的分类数据
      await loadCategoriesFromAPI();
      modalUpload.style.display = 'flex';
    });

    // 上传区域点击触发文件选择
    document.getElementById('uploadArea').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    // 文件选择后显示文件列表
    document.getElementById('fileInput').addEventListener('change', function() {
      if (this.files.length > 0) {
        const uploadFileList = document.getElementById('uploadFileList');
        const fileListContainer = uploadFileList.querySelector('.space-y-2');
        
        // 清空现有文件列表
        fileListContainer.innerHTML = '';
        
        // 动态生成文件列表项
        Array.from(this.files).forEach((file, index) => {
          // 计算文件大小
          let fileSize = '';
          if (file.size < 1024) {
            fileSize = file.size + 'B';
          } else if (file.size < 1024 * 1024) {
            fileSize = (file.size / 1024).toFixed(1) + 'KB';
          } else {
            fileSize = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
          }
          
          // 创建文件列表项
          const fileItem = document.createElement('div');
          fileItem.className = 'flex items-center justify-between p-2 border border-gray-100 rounded-lg';
          fileItem.innerHTML = `
            <div class="flex items-center gap-2">
              <i class="fa fa-file-image-o text-blue-500"></i>
              <span class="text-xs">${file.name}</span>
            </div>
            <span class="text-xs text-gray-500">${fileSize}</span>
            <button class="text-red-400 hover:text-red-600 removeUploadFile" data-index="${index}">
              <i class="fa fa-times"></i>
            </button>
          `;
          fileListContainer.appendChild(fileItem);
        });
        
        // 更新文件列表标题
        uploadFileList.querySelector('.text-sm.font-medium').textContent = `待上传文件 (${this.files.length}/10)`;
        
        // 显示文件列表
        uploadFileList.style.display = 'block';
        showToast(`已选择 ${this.files.length} 个文件`);
        
        // 重新绑定移除文件按钮的事件监听器
        bindRemoveUploadFileEvents();
      }
    });
    
    // 绑定移除上传文件的事件监听器
    function bindRemoveUploadFileEvents() {
      document.querySelectorAll('.removeUploadFile').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('div').remove();
          // 更新文件列表标题
          const uploadFileList = document.getElementById('uploadFileList');
          const fileItems = uploadFileList.querySelectorAll('.flex.items-center.justify-between');
          uploadFileList.querySelector('.text-sm.font-medium').textContent = `待上传文件 (${fileItems.length}/10)`;
          showToast('已移除该文件');
        });
      });
    }

    // 移除上传文件
    document.querySelectorAll('.removeUploadFile').forEach(btn => {
      btn.addEventListener('click', function() {
        this.closest('div').remove();
        showToast('已移除该文件');
      });
    });

    // 开始上传
    document.getElementById('startUploadBtn').addEventListener('click', async function() {
      const fileInput = document.getElementById('fileInput');
      const categorySelect = document.getElementById('uploadCategorySelect');
      
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        showToast('请先选择要上传的图片文件');
        return;
      }
      
      const category = categorySelect ? categorySelect.value : '';
      const files = Array.from(fileInput.files);
      
      closeAllModals();
      showToast('开始上传，预计耗时3秒...');
      
      try {
        // 创建FormData
        const formData = new FormData();
        files.forEach(file => {
          formData.append('files', file);
        });
        formData.append('category', category);
        
        // 发送上传请求
        const response = await fetch('/api/admin/upload', {
          method: 'POST',
          body: formData,
          credentials: 'include' // 包含cookies
        });
        
        const result = await response.json();
        
        if (result.code === 200) {
          // 上传成功
          showToast(`上传成功！新增${result.data.uploaded_count}张图片`);
          
          // 重置文件输入元素
          fileInput.value = '';
        } else {
          // 上传失败
          throw new Error(result.msg || '上传失败');
        }
        
      } catch (error) {
        console.error('上传错误:', error);
        showToast(`上传失败: ${error.message}`);
        
        // 重置文件输入元素
        fileInput.value = '';
      }
    });

    // 全选/取消全选
    document.getElementById('headerCheckbox').addEventListener('change', function() {
      const isChecked = this.checked;
      document.querySelectorAll('.imgCheckbox').forEach(checkbox => {
        checkbox.checked = isChecked;
      });
      showToast(isChecked ? '已全选所有图片' : '已取消全选');
    });
    document.getElementById('selectAllBtn').addEventListener('click', function() {
      document.querySelectorAll('.imgCheckbox').forEach(checkbox => {
        checkbox.checked = true;
      });
      document.getElementById('headerCheckbox').checked = true;
      showToast('已全选所有图片');
    });
    document.getElementById('selectNoneBtn').addEventListener('click', function() {
      document.querySelectorAll('.imgCheckbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.getElementById('headerCheckbox').checked = false;
      showToast('已取消全选');
    });
    document.getElementById('confirmRenameBtn').addEventListener('click', function() {
      closeAllModals();
      showToast('图片重命名成功！');
    });
    document.getElementById('renameSelectedBtn').addEventListener('click', function() {
      document.getElementById('modalRename').style.display = 'flex';
    });

    // 移动图片
    document.querySelectorAll('.moveImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('modalMove').style.display = 'flex';
      });
    });
    document.getElementById('moveSelectedBtn').addEventListener('click', function() {
      document.getElementById('modalMove').style.display = 'flex';
    });
    // 新建分类显示输入框
    document.getElementById('targetCategory').addEventListener('change', function() {
      if (this.value === 'new') {
        document.getElementById('newCategoryInput').style.display = 'block';
      } else {
        document.getElementById('newCategoryInput').style.display = 'none';
      }
    });
    document.getElementById('confirmMoveBtn').addEventListener('click', function() {
      closeAllModals();
      showToast('图片移动成功！');
    });

    // 删除图片
    document.querySelectorAll('.deleteImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('modalDelete').style.display = 'flex';
        const fileName = this.closest('tr').querySelector('td:nth-child(4)').textContent;
        document.getElementById('deleteFileList').innerHTML = `• ${fileName}`;
      });
    });
    document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
      document.getElementById('modalDelete').style.display = 'flex';
    });
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      closeAllModals();
      showToast('图片删除成功！');
      // 模拟删除行
      document.querySelectorAll('.imgCheckbox:checked').forEach(checkbox => {
        checkbox.closest('tr').remove();
      });
    });

    // 下载图片
    document.querySelectorAll('.downloadImgBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        showToast('开始下载图片...');
      });
    });
    document.getElementById('downloadSelectedBtn').addEventListener('click', function() {
      showToast('开始批量下载选中的图片...');
    });

    // 反馈相关
    document.querySelectorAll('.viewFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('modalFeedbackDetail').style.display = 'flex';
      });
    });
    document.querySelectorAll('.resolveFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        showToast('反馈已标记为已处理！');
        this.closest('.border').querySelector('.bg-red-50')?.classList.replace('bg-red-50', 'bg-green-50');
        this.closest('.border').querySelector('.text-red-600')?.classList.replace('text-red-600', 'text-green-600');
        this.closest('.border').querySelector('.rounded-full').textContent = '已解决';
      });
    });
    document.querySelectorAll('.rejectFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        if (confirm('确定要驳回该反馈吗？')) {
          showToast('反馈已驳回！');
          this.closest('.border').querySelector('.bg-red-50')?.classList.replace('bg-red-50', 'bg-gray-50');
          this.closest('.border').querySelector('.text-red-600')?.classList.replace('text-red-600', 'text-gray-600');
          this.closest('.border').querySelector('.rounded-full').textContent = '已驳回';
        }
      });
    });
    document.querySelectorAll('.replyFeedbackBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.getElementById('modalFeedbackDetail').style.display = 'flex';
        showToast('正在打开回复界面...');
      });
    });

    // 检查用户登录状态
    async function checkAuthStatus() {
      try {
        const response = await fetch('/api/auth/verify', {
          credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.code !== 200) {
          // 未登录或登录已过期，跳转到首页
          showToast('登录已过期，请重新登录');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
          
          // 清除登录状态
          localStorage.setItem('auth_status', JSON.stringify({
            isLoggedIn: false,
            timestamp: Date.now()
          }));
        } else {
          // 已登录，更新登录状态
          localStorage.setItem('auth_status', JSON.stringify({
            isLoggedIn: true,
            username: data.data.user.username,
            role: data.data.user.role,
            timestamp: Date.now()
          }));
        }
      } catch (error) {
        console.error('检查登录状态失败:', error);
        // 网络错误时，假设未登录
        localStorage.setItem('auth_status', JSON.stringify({
          isLoggedIn: false,
          timestamp: Date.now()
        }));
      }
    }
    
    // 退出登录
    document.getElementById('logoutBtn').addEventListener('click', function() {
      if (confirm('确定要退出登录吗？')) {
        // 发送退出登录请求到后端API
        fetch('/api/logout', {
          method: 'POST',
          credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
          if (data.code === 200) {
            showToast('已成功退出登录！');
            // 清除登录状态
            localStorage.setItem('auth_status', JSON.stringify({
              isLoggedIn: false,
              timestamp: Date.now()
            }));
            // 退出成功后跳转回首页
            setTimeout(() => {
              window.location.href = '/';
            }, 1000);
          } else {
            showToast('退出登录失败：' + (data.msg || '未知错误'));
          }
        })
        .catch(error => {
          console.error('退出登录请求失败:', error);
          // 即使请求失败也清除登录状态并跳转回首页
          localStorage.setItem('auth_status', JSON.stringify({
            isLoggedIn: false,
            timestamp: Date.now()
          }));
          showToast('已退出登录！');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        });
      }
    });
    
    // 监听存储事件，实现跨页面登录状态同步
    window.addEventListener('storage', function(e) {
      if (e.key === 'auth_status') {
        try {
          const authStatus = JSON.parse(e.newValue);
          if (!authStatus.isLoggedIn) {
            // 其他页面已退出登录，同步状态并跳转到首页
            showToast('登录已过期，请重新登录');
            setTimeout(() => {
              window.location.href = '/';
            }, 1000);
          }
        } catch (error) {
          console.error('解析登录状态失败:', error);
        }
      }
    });
    
    // 定期检查登录状态（每30秒）
    setInterval(checkAuthStatus, 30000);
    
    // 页面加载时检查登录状态
    checkAuthStatus();
    
    // 确认更新图片信息
    document.getElementById('confirmUpdateBtn').addEventListener('click', async function() {
      const modalUpdateInfo = document.getElementById('modalUpdateInfo');
      const imgId = modalUpdateInfo.dataset.imgId;
      let fileName = document.getElementById('updateFileName').value;
      const category = document.getElementById('updateCategorySelect').value;
      
      if (!imgId) {
        showToast('无法获取图片ID');
        return;
      }
      
      if (!fileName) {
        showToast('请输入图片名称');
        return;
      }
      
      // 提取原始文件名的后缀
      const originalFileName = document.getElementById('imgDetailFilename').textContent;
      const lastDotIndex = originalFileName.lastIndexOf('.');
      if (lastDotIndex > 0) {
        const fileExtension = originalFileName.substring(lastDotIndex);
        // 确保新文件名包含原始后缀
        if (fileName.lastIndexOf('.') === -1) {
          // 如果用户输入的文件名没有后缀，添加原始后缀
          fileName += fileExtension;
        } else {
          // 如果用户输入的文件名有后缀，替换为原始后缀
          fileName = fileName.substring(0, fileName.lastIndexOf('.')) + fileExtension;
        }
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/image/${imgId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ filename: fileName, category_id: category })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.code === 200) {
          closeAllModals();
          showToast('图片信息更新成功！');
          
          // 重新加载图片详情
          const viewImgBtn = document.querySelector(`[data-id="${imgId}"]`);
          if (viewImgBtn) {
            viewImgBtn.click();
          }
        } else {
          showToast(`更新失败: ${result.msg}`);
        }
      } catch (error) {
        console.error('更新图片信息失败:', error);
        showToast('更新图片信息失败，请稍后重试');
      }
    });

    // 所有按钮添加点击反馈
    document.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        // 避免重复触发
        if (this.classList.contains('closeModal')) return;
        this.classList.add('opacity-80');
        setTimeout(() => {
          this.classList.remove('opacity-80');
        }, 150);
      });
    });

    // ==================== 主题切换功能 ====================
    // 检查本地存储的主题设置
    const savedTheme = localStorage.getItem('theme');
    const themeIcon = document.getElementById('themeIcon');

    // 应用主题
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
        themeIcon.classList.replace('text-gray-600', 'text-yellow-400');
      } else {
        document.body.classList.remove('dark-mode');
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
        themeIcon.classList.replace('text-yellow-400', 'text-gray-600');
      }
    }

    // 初始化主题
    if (savedTheme) {
      applyTheme(savedTheme);
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // 如果没有保存的设置,但系统偏好是暗色模式
      applyTheme('dark');
    }

    // 主题切换按钮点击事件
    document.getElementById('themeToggleBtn').addEventListener('click', function() {
      const isDarkMode = document.body.classList.contains('dark-mode');

      if (isDarkMode) {
        // 切换到亮色模式
        applyTheme('light');
        localStorage.setItem('theme', 'light');
        showToast('已切换到日间模式');
      } else {
        // 切换到暗色模式
        applyTheme('dark');
        localStorage.setItem('theme', 'dark');
        showToast('已切换到夜间模式');
      }
    });

    // 初始化默认激活第一个菜单
    document.getElementById('menuImgManage').classList.add('active');
    // 默认显示图片管理页面
    document.getElementById('imgManageSection').style.display = 'block';
    // 自动加载图片数据
    loadImagesFromAPI();
  });
</script>

</body>
</html>


